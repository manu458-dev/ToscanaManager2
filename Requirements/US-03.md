# User Story US-03: Multi-Payment Method Sales Recording

## User Story Description

**ID:** US-03

**Priority:** High

**User Story:**
As a **Cashier**, I want to **record sales with multiple payment methods (cash, debit, credit)** so that **customers can pay using their preferred method**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system needs to support modern payment flexibility. Customers expect to be able to pay using their preferred payment method, and the system must accurately track and reconcile each payment type for financial reporting and cash management.

### User Needs
**Cashier:** "Customers come in with different ways to pay. Some prefer cash, others use debit cards, and many use credit cards. I need the system to handle all of these smoothly during checkout."

**System Analyst:** "What specific payment methods do you need to support?"

**Cashier:** "The main three are cash, debit cards, and credit cards. Sometimes customers want to split the payment - like paying part in cash and the rest on a card."

**System Analyst:** "Can you walk me through a typical transaction?"

**Cashier:** "Sure. A customer comes to the register with their order. I scan or enter the items, the system calculates the total, and then I ask how they want to pay. If they say 'credit card,' I select that option and process the card through our terminal. The system should record that this sale was paid by credit card."

**System Analyst:** "What information do you need to capture for each payment type?"

**Cashier:** "For **cash** payments:
- The amount the customer gave me
- The change I need to give back
- The actual payment amount

For **debit cards**:
- The last 4 digits of the card
- The transaction approval code
- The payment amount

For **credit cards**:
- The last 4 digits of the card
- The transaction approval code  
- The payment amount
- Card type (Visa, Mastercard, American Express, etc.)"

**System Analyst:** "What happens if a card payment is declined?"

**Cashier:** "If the card is declined, I need to be able to try a different payment method without losing the sale information. The system should let me switch to cash or try a different card."

**System Analyst:** "You mentioned split payments. How often does that happen?"

**Cashier:** "It's not super common, but maybe 10-15% of transactions. A customer might have a gift card for part of the amount and want to pay the rest in cash. Or they might split between two credit cards."

**System Analyst:** "For split payments, what do you need the system to do?"

**Cashier:** "I need to be able to:
- Apply the first payment method for a specific amount
- See the remaining balance
- Apply a second (or even third) payment method for the remaining amount
- Have all payment methods recorded on the receipt
- Make sure the total of all payments equals the sale amount"

**System Analyst:** "How should the system handle overpayment in cash?"

**Cashier:** "If a customer gives me $50 for a $37.50 purchase, the system should automatically calculate that I need to give $12.50 in change. This should appear on the receipt too."

**System Analyst:** "What about refunds? Do different payment methods require different refund processes?"

**Cashier:** "Yes, that's important. Cash refunds go back in cash. Card refunds need to go back to the original card. The system should track which payment method was used so we know how to refund it."

**System Analyst:** "Do you need to validate that the cash drawer has enough change?"

**Cashier:** "That would be helpful! If I don't have enough small bills or coins to make change, I'd like to know before completing the transaction."

### Business Value
- **Customer Satisfaction:** Provides payment flexibility that meets customer expectations
- **Sales Completion:** Reduces lost sales due to limited payment options
- **Financial Accuracy:** Ensures proper tracking of different payment types for reconciliation
- **Audit Trail:** Maintains detailed records of all payment methods used
- **Cash Management:** Supports accurate cash drawer reconciliation
- **Fraud Prevention:** Records transaction details that help identify suspicious patterns

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Process a Cash Payment
```gherkin
Feature: Multi-Payment Method Processing
  As a Cashier
  I want to record sales with different payment methods
  So that customers can pay using their preferred method

Scenario: Successfully complete a cash payment with change
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $37.50
  And the customer wants to pay with cash
  When I select "Cash" as the payment method
  And I enter the amount tendered as $50.00
  Then the system should calculate the change as $12.50
  And the system should display "Change Due: $12.50"
  And I confirm the cash payment
  Then the sale should be recorded as "Paid"
  And the payment method should be recorded as "Cash"
  And the receipt should show:
    | Field           | Value   |
    | Total           | $37.50  |
    | Cash Tendered   | $50.00  |
    | Change          | $12.50  |
  And the cash drawer should be updated with +$37.50
```

### Scenario 2: Process a Debit Card Payment
```gherkin
Scenario: Successfully complete a debit card payment
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $85.00
  And the customer wants to pay with a debit card
  When I select "Debit Card" as the payment method
  And the customer swipes their debit card ending in "4321"
  And the card terminal returns approval code "AUTH123456"
  And I confirm the debit card payment
  Then the sale should be recorded as "Paid"
  And the payment method should be recorded as "Debit Card"
  And the system should store the last 4 digits as "4321"
  And the system should store the approval code "AUTH123456"
  And the receipt should show:
    | Field              | Value        |
    | Total              | $85.00       |
    | Payment Method     | Debit Card   |
    | Card Last 4        | ****4321     |
    | Approval Code      | AUTH123456   |
```

### Scenario 3: Process a Credit Card Payment
```gherkin
Scenario: Successfully complete a credit card payment  
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $125.50
  And the customer wants to pay with a credit card
  When I select "Credit Card" as the payment method
  And the customer swipes their Visa card ending in "7890"
  And the card terminal returns approval code "APP789012"
  And I confirm the credit card payment
  Then the sale should be recorded as "Paid"
  And the payment method should be recorded as "Credit Card"
  And the card type should be recorded as "Visa"
  And the system should store the last 4 digits as "7890"
  And the system should store the approval code "APP789012"
  And the receipt should show:
    | Field              | Value        |
    | Total              | $125.50      |
    | Payment Method     | Credit Card  |
    | Card Type          | Visa         |
    | Card Last 4        | ****7890     |
    | Approval Code      | APP789012    |
```

### Scenario 4: Handle Declined Card Payment
```gherkin
Scenario: Card payment is declined and customer pays with cash instead
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $42.00
  And the customer attempts to pay with a credit card
  When I select "Credit Card" as the payment method
  And the customer swipes their card
  And the card terminal returns "DECLINED"
  Then the system should display "Payment Declined"
  And the sale should remain in "Pending Payment" status
  And the system should allow me to select a different payment method
  When I select "Cash" as the alternative payment method
  And I enter the amount tendered as $50.00
  And I confirm the cash payment
  Then the sale should be recorded as "Paid"
  And the payment method should be recorded as "Cash"
  And the declined card attempt should be logged for audit purposes
```

### Scenario 5: Process Split Payment with Cash and Card
```gherkin
Scenario: Customer pays with multiple payment methods
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $150.00
  And the customer wants to split the payment
  When I select "Split Payment" option
  And I apply the first payment method:
    | Payment Method | Amount  |
    | Cash           | $50.00  |
  Then the system should show remaining balance as $100.00
  When I apply the second payment method:
    | Payment Method | Amount   | Card Last 4 | Approval Code |
    | Credit Card    | $100.00  | 5555        | APP555666     |
  Then the system should show remaining balance as $0.00
  And I confirm the split payment
  Then the sale should be recorded as "Paid"
  And the system should record both payment methods:
    | Payment Method | Amount   |
    | Cash           | $50.00   |
    | Credit Card    | $100.00  |
  And the receipt should show both payment methods with their amounts
  And the cash drawer should be updated with +$50.00
```

### Scenario 6: Prevent Completing Sale with Insufficient Payment
```gherkin
Scenario: Cannot complete sale when payment doesn't cover total
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $200.00
  And the customer attempts to pay
  When I select "Cash" as the payment method
  And I enter the amount tendered as $150.00
  Then the system should display "Insufficient Payment: Short $50.00"
  And the system should not allow me to complete the sale
  And the system should offer options:
    | Option                           |
    | Add another payment method       |
    | Request additional cash          |
    | Cancel transaction               |
```

### Scenario 7: Process Exact Cash Payment
```gherkin
Scenario: Customer pays exact amount in cash
  Given I am logged in as a Cashier
  And I have added items to a sale totaling $25.00
  And the customer hands me exact change
  When I select "Cash" as the payment method
  And I enter the amount tendered as $25.00
  Then the system should calculate the change as $0.00
  And the system should display "No Change Due"
  And I confirm the cash payment
  Then the sale should be recorded as "Paid"
  And the receipt should show:
    | Field           | Value   |
    | Total           | $25.00  |
    | Cash Tendered   | $25.00  |
    | Change          | $0.00   |
```

### Scenario 8: Record Multiple Credit Card Types
```gherkin
Scenario: System distinguishes between different credit card brands
  Given I am logged in as a Cashier
  And the system supports the following card types:
    | Card Type         |
    | Visa              |
    | Mastercard        |
    | American Express  |
    | Discover          |
  When a customer pays with a Mastercard ending in "1234"
  And the card terminal returns approval code "MC123456"
  And I confirm the credit card payment for $75.00
  Then the payment method should be recorded as "Credit Card"
  And the card type should be recorded as "Mastercard"
  And the system should store the last 4 digits as "1234"
  And this information should appear on the receipt and in reports
```

### Scenario 9: Validate Payment Method Availability
```gherkin
Scenario: Display only payment methods enabled for the branch
  Given I am logged in as a Cashier at branch "BR-003"
  And branch "BR-003" has the following payment methods enabled:
    | Payment Method | Enabled |
    | Cash           | Yes     |
    | Debit Card     | Yes     |
    | Credit Card    | No      |
  When I process a sale and select payment method
  Then the system should display the following payment options:
    | Payment Method |
    | Cash           |
    | Debit Card     |
  And "Credit Card" should not be available as an option
  And if the customer asks to pay by credit card, I should see a message indicating it's not accepted at this location
```

### Scenario 10: Generate Receipt with Payment Details
```gherkin
Scenario: Receipt displays complete payment information
  Given I have completed a sale totaling $95.75
  And the customer paid with a Visa credit card ending in "9999"
  And the approval code was "VIS987654"
  And the transaction date is "2026-02-02" at "14:30:00"
  When the system generates the receipt
  Then the receipt should include:
    | Section          | Details                    |
    | Branch Name      | Toscana Downtown           |
    | Transaction ID   | TXN-20260202-001234        |
    | Date/Time        | 2026-02-02 14:30:00        |
    | Subtotal         | $88.00                     |
    | Tax              | $7.75                      |
    | Total            | $95.75                     |
    | Payment Method   | Credit Card (Visa)         |
    | Card Last 4      | ****9999                   |
    | Approval Code    | VIS987654                  |
  And the receipt should be printed and/or emailed to the customer
```

---
