# User Story US-10: Generate Table Bills with Accurate Totals

## User Story Description

**ID:** US-10

**Priority:** Medium

**User Story:**
As a **Waiter**, I want to **generate table bills with accurate totals** so that **customers can review and pay for their orders efficiently**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system must support efficient table service operations where waiters manage dine-in customers. A critical part of this workflow is generating accurate bills that itemize everything ordered at a table, apply appropriate taxes and any discounts or promotions, and present a clear total for payment. The bill generation must be quick and error-free to provide good customer service.

### User Needs
**Waiter:** "When customers are ready to pay, I need to quickly generate their bill. It should show everything they ordered, the prices, any special requests they had, and the total amount. Customers often review the bill carefully, so it needs to be accurate and easy to read."

**System Analyst:** "Walk me through a typical scenario when a table is ready to pay."

**Waiter:** "The customers signal me that they're ready for the check. I go to my terminal or use a handheld device and select that table - let's say Table 12. The system shows me all the items that have been ordered for that table during their visit. I review it to make sure everything is there - sometimes items get sent to the kitchen but forgot to add to the bill. Then I generate the bill, and it prints out or I can show it on a tablet."

**System Analyst:** "What information needs to be on the bill?"

**Waiter:** "The bill should include:
- Table number
- Date and time
- Server name (me)
- List of all items ordered with quantities and prices
- Any modifiers or special instructions
- Subtotal
- Tax amount and percentage
- Total amount due
- Optional: suggested tip amounts (15%, 18%, 20%)

For each item, customers want to see the individual price and then the line total if they ordered multiple of the same thing."

**Branch Manager:** "From a business perspective, table bills need to be accurate for several reasons:
- They're the basis for payment
- Customers might dispute charges if inaccurate
- They create legal proof of the transaction
- They must comply with tax regulations"

**System Analyst:** "Can multiple people at a table request separate bills?"

**Waiter:** "Yes, this happens all the time! We call it bill splitting. The system needs to let me:
- Split the bill evenly (divide total by number of people)
- Split by seat (each person pays for their specific items)
- Split by item selection (I manually assign items to different bills)
- Custom split (like one person pays for drinks, another for food)

This is really important for customer satisfaction."

**System Analyst:** "How should the system handle discounts or promotions on table bills?"

**Waiter:** "If there's an automatic promotion like 'Happy Hour 20% off drinks', it should already be applied to those items. But sometimes the manager gives a discretionary discount for service recovery - like if food took too long. In that case, I'd need to apply the discount before generating the final bill. The bill should clearly show what discounts were applied."

**System Analyst:** "What if a customer wants to review what they ordered before getting the bill?"

**Waiter:** "Good point. I should be able to show them an 'order summary' that's not yet a formal bill - just a list of what's been ordered. This helps customers decide if they want to add anything else before getting their final bill."

**System Analyst:** "Can bills be regenerated if there's a mistake or the customer loses it?"

**Waiter:** "Yes, but the system should track this. If I generate a new bill for the same table, it should be marked as a duplicate or reprint. This prevents confusion about whether items were double-charged."

**Cashier:** "From my perspective at the register, when waiters bring customers to pay, I need to see the table number and total immediately. The bill they generated should already be in the system so I can just look it up and process payment."

**System Analyst:** "How detailed should item descriptions be?"

**Waiter:** "They should match what the customer ordered. For example:
- 'Margherita Pizza' - not just 'Pizza'
- If they had modifications: 'Margherita Pizza - No Basil, Extra Cheese'
- If it's a combo or meal: Show the main item and included sides

The description should match what they remember ordering."

**System Analyst:** "What about items that were sent back or cancelled? Should they appear on the bill?"

**Waiter:** "No, if an item was cancelled or returned properly through the system, it shouldn't appear on the final bill. But there should be a record somewhere that it was ordered and then removed - for kitchen management purposes."

**System Analyst:** "Should the system suggest tip amounts?"

**Branch Manager:** "This is optional but helpful. Many customers appreciate seeing suggested tips calculated for them. We could show:
- 15% tip: $X
- 18% tip: $Y
- 20% tip: $Z

But make it clear these are suggestions, not requirements. Some regions or cultures don't expect tips, so this should be configurable."

**Waiter:** "Also, I need to know if a bill has been paid. If I generate a bill and the customer goes to pay at the register, the system should mark that bill as 'pending payment' or 'paid' so I don't accidentally generate another one or think the table is still open."

**System Analyst:** "How should the system handle shared items or appetizers?"

**Waiter:** "For bill splitting, shared items are tricky. If two people shared an appetizer, when splitting by seat, I might want to assign it to both of them (split the cost) or to one person who agrees to cover it. The system should give me flexibility in how to allocate shared items."

### Business Value
- **Customer Satisfaction:** Quick, accurate bills improve dining experience
- **Payment Efficiency:** Reduces time customers spend waiting to pay
- **Accuracy:** Prevents disputes over charges and ensures proper taxation
- **Flexibility:** Bill splitting options accommodate different customer preferences
- **Legal Compliance:** Proper documentation of dine-in transactions
- **Integration:** Bills feed into payment processing and sales reporting

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Generate Standard Table Bill
```gherkin
Feature: Generate Table Bills with Accurate Totals
  As a Waiter
  I want to generate table bills with accurate totals
  So that customers can review and pay for their orders efficiently

Scenario: Successfully generate bill for table with multiple items
  Given I am logged in as a Waiter
  And I am serving table "T-12"
  And table "T-12" has the following orders:
    | Item                  | Quantity | Unit Price | Modifiers        | Line Total |
    | Margherita Pizza      | 2        | $14.00     | None             | $28.00     |
    | Caesar Salad          | 1        | $9.00      | Dressing on side | $9.00      |
    | Spaghetti Carbonara   | 1        | $16.00     | None             | $16.00     |
    | Soft Drink            | 3        | $3.00      | None             | $9.00      |
  And the subtotal is $62.00
  And tax rate is 8%
  And tax amount is $4.96
  And total is $66.96
  When I select table "T-12"
  And I click "Generate Bill"
  Then the system should create a bill showing:
    | Section               | Content                               |
    | Table Number          | T-12                                  |
    | Server                | [My name]                             |
    | Date/Time             | 2026-02-02 14:13:35                   |
    | Items List            | All 4 items with quantities & prices  |
    | Subtotal              | $62.00                                |
    | Tax (8%)              | $4.96                                 |
    | Total                 | $66.96                                |
  And each item should show modifiers if applicable
  And the bill should be available in both printed and digital format
  And the bill should be marked as "Pending Payment"
```

### Scenario 2: Generate Bill with Discounts Applied
```gherkin
Scenario: Bill shows promotional and manager discounts clearly
  Given I am serving table "T-05"
  And the table has ordered items totaling $100.00 (before discounts)
  And "Happy Hour" discount of 20% applies to drink items ($20.00)
  And a manager discretionary discount of $10.00 was applied for service recovery
  And the adjusted subtotal is $70.00
  And tax (8%) is $5.60
  And total is $75.60
  When I generate the bill
  Then the bill should show:
    | Line Item                           | Amount    |
    | Food & Beverage Subtotal            | $100.00   |
    | Less: Happy Hour Discount (20%)     | -$20.00   |
    | Less: Manager Courtesy Discount     | -$10.00   |
    | Subtotal after discounts            | $70.00    |
    | Tax (8%)                            | $5.60     |
    | **Total Due**                       | $75.60    |
  And discounts should be itemized separately
  And the bill should note "Total Savings: $30.00"
```

### Scenario 3: Split Bill Evenly Among Multiple Guests
```gherkin
Scenario: Divide bill equally among 4 guests
  Given I am serving table "T-08"
  And the total bill is $120.00 (including tax)
  And the customers want to split the bill evenly among 4 people
  When I select "Split Bill Evenly"
  And I enter the number of splits as "4"
  Then the system should calculate $30.00 per person
  And generate 4 separate bills each showing:
    | Field                     | Value                           |
    | Bill Type                 | Split Bill (1 of 4)             |
    | Original Table            | T-08                            |
    | Share Amount              | $30.00                          |
    | Original Total            | $120.00                         |
  And each bill should be individually payable
  And the system should track that all 4 payments are needed to close the table
```

### Scenario 4: Split Bill by Seat Assignment
```gherkin
Scenario: Generate separate bills based on who ordered what
  Given I am serving table "T-15"
  And I have assigned seat numbers to guests when taking orders
  And the orders are distributed as:
    | Seat | Items Ordered               | Seat Total |
    | 1    | Pizza, Wine                 | $28.00     |
    | 2    | Pasta, Soft Drink           | $19.00     |
    | 3    | Salad, Water (free)         | $9.00      |
  When I select "Split Bill by Seat"
  Then the system should generate 3 separate bills:
    | Bill | Seat | Items                     | Total  |
    | 1    | 1    | Pizza, Wine               | $28.00 |
    | 2    | 2    | Pasta, Soft Drink         | $19.00 |
    | 3    | 3    | Salad, Water              | $9.00  |
  And each bill should include appropriate tax
  And each bill should reference table "T-15"
```

### Scenario 5: Handle Shared Items in Bill Split
```gherkin
Scenario: Allocate shared appetizer when splitting by seat
  Given I am serving table "T-20"
  And there is a shared appetizer "Bruschetta" for $12.00
  And two guests at seats 1 and 2 shared it
  And I am splitting the bill by seat
  When the system encounters the shared item
  Then I should be prompted "How should 'Bruschetta' be allocated?"
  And I should see options:
    | Option                        | Result                     |
    | Split between Seats 1 and 2   | $6.00 each                 |
    | Assign to Seat 1              | $12.00 to Seat 1           |
    | Assign to Seat 2              | $12.00 to Seat 2           |
    | Split among all guests        | Divided by all seats       |
  When I select "Split between Seats 1 and 2"
  Then the appetizer cost should be divided equally between those two bills
```

### Scenario 6: Include Suggested Tip Amounts
```gherkin
Scenario: Bill displays suggested tip calculations
  Given I have generated a bill for table "T-07"
  And the total (before tip) is $85.00
  And tip suggestions are enabled for this branch
  When the bill is generated
  Then it should include a "Suggested Gratuity" section:
    | Tip Percentage | Amount  | Total with Tip |
    | 15%            | $12.75  | $97.75         |
    | 18%            | $15.30  | $100.30        |
    | 20%            | $17.00  | $102.00        |
  And the section should note "Gratuity is not included and is at your discretion"
  And this should appear below the total line
```

### Scenario 7: Regenerate or Reprint Bill
```gherkin
Scenario: Customer requests duplicate copy of their bill
  Given I previously generated a bill for table "T-10"
  And the bill number is "BILL-20260202-0123"
  And the customer has lost their copy
  When I search for table "T-10"
  And I select "Reprint Bill"
  Then the system should regenerate the same bill
  And mark it as "DUPLICATE COPY"
  And include the original bill number
  And note on the bill: "Reprint - Original issued at [timestamp]"
  And the reprint action should be logged for audit purposes
```

### Scenario 8: Preview Order Summary Before Final Bill
```gherkin
Scenario: Show customers their orders before generating official bill
  Given I am serving table "T-18"
  And customers want to review what they ordered before paying
  When I select "Show Order Summary"
  Then the system should display an informal summary showing:
    | Item                  | Quantity | Price   |
    | Margherita Pizza      | 1        | $14.00  |
    | Caesar Salad          | 2        | $18.00  |
    | Soda                  | 2        | $6.00   |
    | Estimated Total       | -        | ~$38.00 |
  And this should NOT create an official bill
  And it should be viewable on my tablet or terminal
  And customers can decide to add more items before requesting the actual bill
```

### Scenario 9: Prevent Bill Generation for Already Paid Table
```gherkin
Scenario: System prevents duplicate billing for paid tables
  Given table "T-22" has already been paid
  And the payment was completed 5 minutes ago
  And the table status is "Paid - Awaiting Cleanup"
  When I attempt to generate a bill for table "T-22"
  Then the system should display "Table T-22 has already been paid"
  And show payment details:
    | Field              | Value                    |
    | Paid At            | 14:08:35                 |
    | Payment Method     | Credit Card              |
    | Amount             | $67.50                   |
  And prevent generation of a new bill
  And suggest I clear the table to make it available for new customers
```

### Scenario 10: Include All Item Details and Modifications
```gherkin
Scenario: Bill clearly shows item customizations
  Given I am serving table "T-25"
  And the table ordered:
    | Item                | Modifiers/Notes                   | Price  |
    | Margherita Pizza    | No basil, Extra cheese, Well done | $14.00 |
    | Caesar Salad        | Dressing on side, Add chicken     | $12.00 |
    | Spaghetti Carbonara | No bacon (vegetarian)             | $15.00 |
  When I generate the bill
  Then each item should display with its modifications:
    """
    Margherita Pizza                              $14.00
      - No basil
      - Extra cheese
      - Well done
    
    Caesar Salad                                  $12.00
      - Dressing on side
      - Add chicken
    
    Spaghetti Carbonara                           $15.00
      - No bacon (vegetarian)
    """
  And modifications should be clearly indented or marked
  And this helps customers verify they received what they ordered
```

---
