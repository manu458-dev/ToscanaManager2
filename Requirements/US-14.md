# User Story US-14: Authorized Cancellations and Returns

## User Story Description

**ID:** US-14

**Priority:** High

**User Story:**
As a **Cashier**, I want to **perform cancellations and returns only with authorization and documented reasons** so that **all transaction reversals are legitimate and auditable**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system must implement strict controls over transaction cancellations and returns to prevent fraud and maintain financial integrity. While legitimate cancellations and returns are a normal part of business operations, they represent opportunities for abuse if not properly controlled. The system must require authorization and documentation for all transaction reversals while still allowing efficient service recovery.

### User Needs
**Cashier:** "Sometimes customers change their mind or we make a mistake and need to cancel a transaction. Other times, a customer returns food they're not satisfied with. I need to be able to handle these situations, but I understand there need to be controls to prevent fraud."

**System Analyst:** "Let's discuss the different scenarios. What's the difference between a cancellation and a return?"

**Cashier:** "A **cancellation** or **void** is when we stop a transaction before it's completed - like if a customer decides not to buy something after I've started ringing it up. A **return** or **refund** is when we give money back after the sale is already completed and paid for."

**Branch Manager:** "From my perspective, both cancellations and returns are high-risk operations that need proper controls:
- They directly reduce our revenue
- They can be used to steal money ('sweethearting' - giving free items to friends)
- They need to be tracked for pattern analysis
- Every reversal should have a documented, legitimate reason"

**System Analyst:** "What level of authorization should be required?"

**Branch Manager:** "It should depend on the amount and timing:
- **Small cancellations** (under $20 before payment): Cashiers can do it with just a documented reason
- **Large cancellations** (over $20 or already paid): Require manager approval
- **All returns/refunds**: Always require manager approval regardless of amount
- **Same-day returns**: Slightly easier process
- **Returns after multiple days**: Stricter verification"

**Cashier:** "What reasons should be acceptable for cancellations?"

**Branch Manager:** "Common legitimate reasons include:
- Customer changed mind
- Wrong item entered by cashier
- Price discrepancy  
- Duplicate transaction
- Customer insufficient funds/payment declined

The system should have a predefined list but also allow custom reasons."

**System Analyst:** "What about return reasons?"

**Cashier:** "For returns, typical reasons are:
- Food quality issue (too cold, overcooked, wrong order)
- Customer dissatisfaction
- Allergic reaction concern
- Wrong item delivered
- Duplicate charge"

**System Analyst:** "How should the authorization workflow work?"

**Cashier:** "When I need to void a transaction, I should:
1. Select the transaction to void
2. Choose a reason from the list
3. Add any notes explaining the situation
4. Request authorization (if required)
5. Manager enters their credentials to approve
6. System processes the void/refund"

**Branch Manager:** "I should get a notification when approval is needed. I want to see:
- What transaction is being voided/refunded
- How much money is involved
- Who is requesting it
- Why they're requesting it

Then I can approve or deny based on whether it seems legitimate."

**System Analyst:** "What happens if a manager denies the request?"

**Cashier:** "Then the transaction stays as-is, and I need to explain to the customer why we can't process the void or refund. The denial should be logged too."

**System Analyst:** "Can refunds be partial?"

**Branch Manager:** "Yes, that's important. If a customer ordered three items and only one was bad, we should refund just that item, not the whole transaction. The system needs to:
- Show all items in the original transaction
- Let us select which items to refund
- Calculate the partial refund amount
- Update the receipt accordingly"

**System Analyst:** "How should refunds be issued?"

**Cashier:** "Refunds should go back via the original payment method:
- Cash purchases → Cash refund
- Credit card purchases → Refund to the same card
- Debit card purchases → Refund to the same card
- Split payments → Refund proportionally to each method"

**System Analyst:** "What documentation should be created?"

**Branch Manager:** "For every void or refund, we need:
- Original transaction number/receipt
- Date and time of reversal
- Items affected
- Amount refunded
- Reason and notes
- Who requested it (cashier)
- Who authorized it (manager)
- New receipt showing the refund

This creates a complete audit trail."

**System Analyst:** "Are there any limits on how old a transaction can be for returns?"

**Branch Manager:** "Good question. We should have a return window:
- Same day: Full flexibility with manager approval
- Within 7 days: Requires receipt and manager approval
- After 7 days: Generally not accepted (exceptional cases need General Director approval)

The system should enforce these rules."

**General Director:** "I want visibility into void and refund patterns:
- Which cashiers have high void rates (possible fraud)
- Which branches have unusual return patterns
- Most common void/refund reasons
- Total impact on revenue

This helps me identify training needs or potential security issues."

**System Analyst:** "Should there be daily limits on voids/refunds?"

**Branch Manager:** "That's a good safeguard. Maybe limit cashiers to 3 voids per shift, and if they need more, require special approval. High void rates often indicate problems."

### Business Value
- **Fraud Prevention:** Authorization requirements deter theft and sweethearting
- **Audit Trail:** Complete documentation of all transaction reversals
- **Customer Service:** Allows legitimate service recovery while maintaining controls
- **Loss Prevention:** Reduces revenue losses from unauthorized voids/refunds
- **Accountability:** Clear tracking of who authorized what
- **Pattern Detection:** Identifies potential fraud or training needs

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Cancel Small Transaction Without Manager Approval
```gherkin
Feature: Authorized Cancellations and Returns
  As a Cashier
  I want to perform cancellations and returns with authorization and documented reasons
  So that all transaction reversals are legitimate and auditable

Scenario: Void a transaction under $20 with documented reason
  Given I am logged in as a Cashier
  And I have started a transaction with:
    | Item          | Price  |
    | Soft Drink    | $3.00  |
    | Caesar Salad  | $9.00  |
    | Total         | $12.00 |
  And the transaction has not been paid yet
  And the customer has changed their mind about purchasing
  When I select "Void Transaction"
  And I choose reason "Customer changed mind"
  And I add note "Customer decided to order at table instead"
  And I confirm the void
  Then the system should process the void without manager approval (under $20 threshold)
  And the transaction should be marked as "Voided"
  And all items should be removed from the sale
  And a void receipt should be printed showing:
    | Field              | Value                        |
    | Transaction ID     | [Original transaction ID]    |
    | Voided By          | [My cashier ID]              |
    | Reason             | Customer changed mind        |
    | Notes              | Customer decided to order... |
    | Amount Voided      | $12.00                       |
    | Date/Time          | 2026-02-02 15:01:08          |
  And the void should be logged for audit purposes
```

### Scenario 2: Cancel Large Transaction Requiring Manager Approval
```gherkin
Scenario: Void transaction over $20 requires manager authorization
  Given I am logged in as a Cashier
  And I have an active transaction totaling $75.00
  And the customer wants to cancel before payment
  When I select "Void Transaction"
  And I choose reason "Customer insufficient funds"
  And I request void authorization
  Then the system should display "Manager approval required for voids over $20"
  And prompt for manager credentials
  When the Branch Manager enters credentials
  And reviews the void request:
    | Field        | Value                       |
    | Amount       | $75.00                      |
    | Cashier      | [My name]                   |
    | Reason       | Customer insufficient funds |
  And approves the void
  Then the transaction should be voided
  And the void should be logged with both cashier and manager IDs
```

### Scenario 3: Manager Denies Void Request
```gherkin
Scenario: Manager rejects void request as inappropriate
  Given I am logged in as a Cashier
  And I have requested to void a $50.00 transaction
  And the reason given is "Customer changed mind"
  And the manager reviews the request
  When the manager determines the reason is insufficient
  And denies the void request with note "Customer already consumed items - cannot void"
  Then the void should not be processed
  And the transaction should remain active
  And I should see notification "Void request denied by manager"
  And the denial should be logged with manager's note
  And I should need to explain to customer why void was denied
```

### Scenario 4: Process Full Refund for Paid Transaction
```gherkin
Scenario: Refund entire transaction with manager approval
  Given a customer has a receipt for transaction "TXN-20260202-001234"
  And the transaction was paid by credit card
  And the total was $45.00
  And the purchase was made 2 hours ago (same day)
  And the customer is unsatisfied with their order
  When I am logged in as a Cashier
  And I select "Process Refund"
  And I enter the original transaction number "TXN-20260202-001234"
  And the system retrieves the transaction details
  And I select "Refund Full Amount"
  And I choose reason "Customer dissatisfaction - food quality"
  And I add note "Customer said pasta was undercooked"
  And I request manager authorization
  When the Branch Manager reviews and approves
  Then the system should process a refund of $45.00
  And initiate credit card refund to original card (****1234)
  And generate a refund receipt showing:
    | Field                 | Value                           |
    | Refund Type           | Full Refund                     |
    | Original Transaction  | TXN-20260202-001234             |
    | Refund Amount         | $45.00                          |
    | Refund Method         | Credit Card ****1234            |
    | Reason                | Food quality issue              |
    | Authorized By         | [Manager name]                  |
```

### Scenario 5: Process Partial Refund
```gherkin
Scenario: Refund only specific items from original transaction
  Given a customer has receipt for transaction "TXN-20260202-005678"
  And the original transaction included:
    | Item                | Quantity | Price  | Line Total |
    | Margherita Pizza    | 1        | $14.00 | $14.00     |
    | Caesar Salad        | 1        | $9.00  | $9.00      |
    | Spaghetti Carbonara | 1        | $16.00 | $16.00     |
    | Total               | -        | -      | $39.00     |
  And the customer wants to return only the Spaghetti
  When I process a refund for this transaction
  And I select "Partial Refund"
  And I check only "Spaghetti Carbonara ($16.00)"
  And I enter reason "Customer allergic reaction concern"
  And manager approves
  Then the system should calculate partial refund of $16.00
  And process refund for only that item
  And the other items should remain as purchased
  And the refund receipt should itemize which items were refunded
```

### Scenario 6: Prevent Refund Outside Return Window
```gherkin
Scenario: System blocks refund for transaction older than policy
  Given the return policy is 7 days
  And a customer has a receipt from 10 days ago
  And transaction ID is "TXN-20260123-003456"
  When I attempt to process a refund
  And I enter the transaction number
  Then the system should display "Transaction is 10 days old - exceeds 7-day return window"
  And prevent processing the refund
  And suggest I contact the General Director for exception approval
  And log the attempted refund outside policy window
```

### Scenario 7: Refund to Original Payment Method
```gherkin
Scenario: Ensure refund uses same payment method as original purchase
  Given transaction "TXN-20260202-007890" was paid with:
    | Payment Method | Amount  |
    | Cash           | $30.00  |
    | Credit Card    | $20.00  |
    | Total          | $50.00  |
  And customer is requesting full refund
  When I process the refund with manager approval
  Then the system should refund:
    | Refund Method  | Amount  |
    | Cash           | $30.00  |
    | Credit Card    | $20.00  |
  And I should provide $30.00 cash to the customer
  And initiate $20.00 credit card refund
  And both refunds should be documented on the refund receipt
```

### Scenario 8: Track Void Patterns for Fraud Detection
```gherkin
Scenario: System alerts manager when cashier exceeds void limit
  Given I am logged in as a Cashier
  And I have already voided 3 transactions today
  And the daily void limit is 3 per cashier
  When I attempt to void a 4th transaction
  Then the system should display "You have exceeded the daily void limit (3)"
  And require Branch Manager override
  And notify the Branch Manager "Cashier [name] has requested 4th void today - review recommended"
  And if approved, log the exception approval
  And flag this in the manager's daily review report
```

### Scenario 9: Void Transaction Line Item Instead of Entire Transaction
```gherkin
Scenario: Remove single item from active transaction
  Given I am logged in as a Cashier
  And I have an active transaction with:
    | Item            | Quantity | Price  |
    | Pizza           | 1        | $14.00 |
    | Salad           | 1        | $9.00  |
    | Drink           | 2        | $6.00  |
  And the customer wants to remove the drinks
  When I select the "Drink" line item
  And I click "Remove Item"
  And I choose reason "Customer changed mind"
  Then the system should remove only the drinks ($6.00)
  And the transaction should update to new total of $23.00
  And the removal should be logged showing which item was removed
  And the transaction should remain active for payment
```

### Scenario 10: Generate Void/Refund Analytics Report
```gherkin
Scenario: Branch Manager reviews void and refund patterns
  Given I am logged in as a Branch Manager
  And today's date is "2026-02-02"
  When I navigate to "Void & Refund Report" for the past 7 days
  Then I should see a report showing:
    | Metric                          | Value |
    | Total Voids                     | 45    |
    | Total Void Amount               | $890  |
    | Total Refunds                   | 12    |
    | Total Refund Amount             | $430  |
  And a breakdown by cashier:
    | Cashier      | Voids | Void Amount | Refunds | Refund Amount |
    | John Smith   | 8     | $145        | 2       | $80           |
    | Susan Lee    | 15    | $320        | 4       | $150          |
    | Mike Johnson | 6     | $95         | 1       | $40           |
  And most common reasons:
    | Reason                  | Count |
    | Customer changed mind   | 18    |
    | Wrong item entered      | 12    |
    | Food quality issue      | 8     |
  And I should be able to identify outliers requiring investigation
```

---
