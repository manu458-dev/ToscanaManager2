# User Story US-02: Role-Based Permissions with Branch-Level Scope

## User Story Description

**ID:** US-02

**Priority:** High

**User Story:**
As a **Branch Manager**, I want to **assign role-based permissions with branch-level scope** so that **employees can only access data relevant to their branch and responsibilities**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system requires a robust permission system that combines role-based access control with branch-level data isolation. Branch Managers need the ability to control what their employees can do within the system, while ensuring that employees cannot access data from other branches.

### User Needs
**Branch Manager:** "I need to be able to control what my staff can do in the system. For example, my cashiers should be able to process sales and handle payments, but they shouldn't be able to modify the product catalog or see financial reports."

**System Analyst:** "So you need to assign different permission levels based on job roles?"

**Branch Manager:** "Exactly. And it's crucial that my employees can only see and work with data from our branch. If a cashier transfers to another location, they should only see data from their new branch, not the old one."

**System Analyst:** "What roles do you typically have at your branch?"

**Branch Manager:** "We have several roles:
- **Cashiers** who handle sales transactions and payments
- **Waiters** who manage table orders and customer service
- **Kitchen staff** who need to see orders but not financial data
- **Shift supervisors** who can do most of what I do, except modify user accounts
- And myself as **Branch Manager** with full control over the branch"

**System Analyst:** "What specific permissions should each role have?"

**Branch Manager:** "Let me break it down:
- **Cashiers:** Record sales, apply authorized discounts, process payments, generate receipts, perform cash register closings
- **Waiters:** Create table orders, add products to orders, generate bills, register customer complaints
- **Shift Supervisors:** Everything cashiers do, plus view daily sales reports and validate cash closes
- **Branch Manager:** All of the above, plus manage user accounts, configure branch settings, access all reports"

**System Analyst:** "Should you be able to create custom roles or modify existing ones?"

**Branch Manager:** "Standard roles should be pre-defined to maintain consistency across all branches, but I should be able to assign and revoke these roles for my employees. I don't think we need custom roles - the standard ones should cover our needs. However, if we do need changes to role permissions, that should be handled by the General Director to maintain consistency."

**System Analyst:** "What happens when an employee needs temporary elevated permissions?"

**Branch Manager:** "Good question. Sometimes I might need a supervisor to cover for me. The system should allow temporary role assignments with automatic expiration. For example, I could grant supervisor 'Manager' permissions for a specific date range."

**System Analyst:** "How should the system handle employees who work at multiple branches?"

**Branch Manager:** "That's rare, but it happens. An employee should have a primary branch assignment. If they need access to multiple branches, that should be a special case that requires General Director approval, not something I can do."

### Business Value
- **Security:** Prevents unauthorized access to sensitive data and functions
- **Data Integrity:** Ensures employees can only modify data they're responsible for
- **Compliance:** Maintains audit trails and supports regulatory requirements
- **Operational Efficiency:** Employees see only relevant information without clutter
- **Accountability:** Clear role assignments make it easy to track who did what
- **Flexibility:** Supports temporary role changes for vacation coverage and training

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Assign a Role to a New Employee
```gherkin
Feature: Role-Based Permission Assignment
  As a Branch Manager
  I want to assign roles to employees at my branch
  So that they have appropriate permissions for their responsibilities

Scenario: Successfully assign a Cashier role to a new employee
  Given I am logged in as a Branch Manager for branch "BR-001"
  And a new employee "John Smith" has been created in the system
  And "John Smith" is assigned to branch "BR-001"
  And "John Smith" currently has no role assigned
  When I navigate to the user management section
  And I select employee "John Smith"
  And I assign the role "Cashier" to "John Smith"
  And I save the role assignment
  Then "John Smith" should have the "Cashier" role
  And "John Smith" should have the following permissions:
    | Permission                    | Access  |
    | Record Sales                  | Yes     |
    | Process Payments              | Yes     |
    | Apply Discounts               | Yes     |
    | Generate Receipts             | Yes     |
    | Perform Cash Register Closing | Yes     |
    | Modify Product Catalog        | No      |
    | View Financial Reports        | No      |
    | Manage User Accounts          | No      |
  And the system should log the role assignment with timestamp
```

### Scenario 2: Branch-Level Data Isolation for Employees
```gherkin
Scenario: Employee can only access data from their assigned branch
  Given employee "Maria Garcia" has the role "Cashier"
  And "Maria Garcia" is assigned to branch "BR-002"
  And branch "BR-002" has 25 sales transactions today
  And branch "BR-003" has 30 sales transactions today
  When "Maria Garcia" logs into the system
  And she navigates to the sales history section
  Then she should only see the 25 transactions from branch "BR-002"
  And she should not see any transactions from branch "BR-003"
  And the system should automatically filter all queries by branch "BR-002"
  And she should not have any option to switch to a different branch
```

### Scenario 3: Prevent Unauthorized Actions Based on Role
```gherkin
Scenario: Cashier cannot access user management functions
  Given I am logged in as employee "John Smith"
  And I have the role "Cashier" at branch "BR-001"
  When I attempt to navigate to the user management section
  Then the system should deny access
  And the system should display the message "Access Denied: Insufficient permissions"
  And the system should log the unauthorized access attempt
  And I should be redirected to my role-appropriate dashboard
```

### Scenario 4: Branch Manager Assigns Multiple Roles
```gherkin
Scenario: Assign different roles to multiple employees
  Given I am logged in as a Branch Manager for branch "BR-005"
  And I have the following employees at my branch:
    | Employee Name    | Current Role |
    | Alice Johnson    | None         |
    | Bob Martinez     | None         |
    | Carol White      | None         |
  When I assign the following roles:
    | Employee Name    | New Role          |
    | Alice Johnson    | Waiter            |
    | Bob Martinez     | Cashier           |
    | Carol White      | Shift Supervisor  |
  Then each employee should have their assigned role
  And each employee should have permissions specific to their role
  And all role assignments should be logged with my user ID and timestamp
```

### Scenario 5: Update an Employee's Role
```gherkin
Scenario: Change an employee's role due to promotion
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "David Lee" currently has the role "Cashier"
  And "David Lee" has been promoted to "Shift Supervisor"
  When I navigate to edit "David Lee's" profile
  And I change his role from "Cashier" to "Shift Supervisor"
  And I save the changes
  Then "David Lee" should have the role "Shift Supervisor"
  And his permissions should be updated to match the "Shift Supervisor" role
  And he should now have access to daily sales reports
  And he should now be able to validate cash closes
  And the system should log the role change with old role, new role, and timestamp
```

### Scenario 6: Revoke Role from an Employee
```gherkin
Scenario: Remove role from a departing employee
  Given I am logged in as a Branch Manager for branch "BR-004"
  And employee "Emma Wilson" has the role "Waiter"
  And "Emma Wilson" is leaving the company
  When I navigate to "Emma Wilson's" profile
  And I select "Deactivate User"
  And I confirm the deactivation
  Then "Emma Wilson's" account should be marked as inactive
  And all her role permissions should be revoked
  And she should not be able to log into the system
  And her historical actions should remain in the audit log
  And the deactivation should be logged with reason and timestamp
```

### Scenario 7: Temporary Role Assignment with Expiration
```gherkin
Scenario: Grant temporary elevated permissions for vacation coverage
  Given I am logged in as a Branch Manager for branch "BR-006"
  And employee "Frank Chen" currently has the role "Shift Supervisor"
  And I will be on vacation from "2026-02-10" to "2026-02-17"
  When I navigate to "Frank Chen's" profile
  And I select "Grant Temporary Role"
  And I assign the temporary role "Branch Manager"
  And I set the start date to "2026-02-10"
  And I set the end date to "2026-02-17"
  And I save the temporary role assignment
  Then "Frank Chen" should have "Shift Supervisor" as his primary role
  And "Frank Chen" should have a temporary role "Branch Manager" scheduled
  And starting on "2026-02-10", "Frank Chen" should have "Branch Manager" permissions
  And on "2026-02-18", the system should automatically revert "Frank Chen" to "Shift Supervisor"
  And the system should send a notification before the temporary role expires
```

### Scenario 8: Prevent Branch Manager from Assigning Roles Outside Their Branch
```gherkin
Scenario: Branch Manager cannot assign roles to employees from other branches
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "Grace Taylor" is assigned to branch "BR-002"
  When I attempt to search for "Grace Taylor" in my user management section
  Then "Grace Taylor" should not appear in my employee list
  And I should only see employees assigned to branch "BR-001"
  And the system should prevent me from modifying any user from a different branch
```

### Scenario 9: View Role Permissions Matrix
```gherkin
Scenario: Branch Manager reviews what permissions each role has
  Given I am logged in as a Branch Manager
  When I navigate to the "Roles and Permissions" reference section
  Then I should see a matrix showing all available roles
  And for each role, I should see the complete list of permissions
  And the matrix should display:
    | Role              | Record Sales | View Reports | Manage Users | Process Payments | Generate Bills |
    | Cashier           | Yes          | No           | No           | Yes              | No             |
    | Waiter            | No           | No           | No           | No               | Yes            |
    | Shift Supervisor  | Yes          | Yes          | No           | Yes              | Yes            |
    | Branch Manager    | Yes          | Yes          | Yes          | Yes              | Yes            |
  And this should be read-only reference information
```

### Scenario 10: Multiple Employees with Same Role Have Consistent Permissions
```gherkin
Scenario: All cashiers have identical permissions regardless of who assigned them
  Given branch "BR-001" has employee "Alex Brown" with role "Cashier"
  And branch "BR-002" has employee "Sam Green" with role "Cashier"
  And both were assigned the "Cashier" role by their respective Branch Managers
  When I compare the permissions of both employees
  Then "Alex Brown" and "Sam Green" should have identical permissions
  And both should have access to the same system functions
  And the "Cashier" role should be standardized across all branches
```

---
