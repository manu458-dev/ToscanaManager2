# User Story US-07: Daily and Weekend Cash Close Validation

## User Story Description

**ID:** US-07

**Priority:** High

**User Story:**
As a **Branch Manager**, I want to **execute and validate daily/weekend cash closes** so that **recorded sales match physical cash and discrepancies are identified**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system must support rigorous cash reconciliation processes to ensure financial accuracy and identify discrepancies promptly. Daily and weekend cash closes are critical control points where the Branch Manager verifies that physical cash matches the system's recorded sales, providing accountability and detecting potential issues such as theft, errors, or system problems.

### User Needs
**Branch Manager:** "At the end of each business day, I need to reconcile all cash drawers and make sure everything balances. This is one of my most important responsibilities - if the cash doesn't match what the system says we should have, I need to know immediately."

**System Analyst:** "Walk me through your current cash closing process."

**Branch Manager:** "First, all cashiers complete their individual cash register closings - they count their drawer and report what they have. Then I review all of those closings and combine them for the daily close. I need to see:
- Total cash sales for the day
- Total card payments (debit and credit separately)
- Expected cash in drawers (starting balance + cash sales - change given)
- Actual cash counted
- Any discrepancies"

**System Analyst:** "What's different about weekend closes versus daily closes?"

**Branch Manager:** "Weekend closes happen on Sunday nights or Monday mornings and cover Friday, Saturday, and Sunday. It's essentially the same process but for three days combined. We need to see cumulative totals and make sure everything reconciles for the entire weekend period."

**System Analyst:** "What happens when you find a discrepancy?"

**Branch Manager:** "That's where it gets important. If there's a discrepancy, I need to:
- Document the amount (over or short)
- Investigate possible causes
- Note which cashier's drawer had the issue
- Add comments explaining what happened if we figure it out
- If it's a significant amount, I might need to escalate to the General Director

The system should flag discrepancies over a certain threshold - say $10 - as requiring explanation."

**Cashier:** "From my perspective, at the end of my shift I need to count my drawer and enter the amounts. The system should tell me if I'm over or short so I can recount if needed."

**System Analyst:** "Should cashiers be able to complete their closing without manager approval?"

**Branch Manager:** "Yes, cashiers should complete their individual register closings. But I need to review and approve all of them before I can complete the daily close. If a cashier has a significant shortage, I might ask them to recount before I approve."

**System Analyst:** "What reports or documentation should the cash close generate?"

**Branch Manager:** "I need:
- A detailed cash close report showing all transactions, payment methods, totals, and reconciliation
- A summary showing expected vs. actual for quick review
- A variance report highlighting any discrepancies
- Historical tracking so I can see trends (like if a particular cashier consistently has small shortages)

This report needs to be printable and also saved in the system for auditing."

**System Analyst:** "What if there's a problem preventing the cash close - like a cashier forgot to log out or there's an open transaction?"

**Branch Manager:** "The system should check for these issues and alert me:
- Any active sessions that haven't been closed
- Any pending transactions
- Any cash drawers that haven't been closed
- Any returns or voids pending approval

I should be able to see a checklist of what's blocking the close and resolve each issue."

**General Director:** "From my level, I need visibility into all branch closings. I should receive notifications if:
- A branch fails to complete their daily close on time
- There are significant discrepancies at any branch
- A weekend close is missed

I should also be able to review historical close reports to identify patterns or problems."

**System Analyst:** "Should the system enforce any rules about timing for closes?"

**Branch Manager:** "Yes, good point:
- Daily close should typically be done within an hour after closing time
- Weekend close should be done by Monday morning before opening
- The system should send reminders if a close is overdue
- We should be able to complete a late close with explanation if needed"

**System Analyst:** "What about cash deposits to the bank?"

**Branch Manager:** "After completing the daily or weekend close, I prepare a bank deposit. The system should:
- Show me how much cash should be deposited (total minus the starting drawer amount for next day)
- Let me record the deposit amount and date
- Track when deposits are made vs. when closes are completed
- Alert if cash is building up and hasn't been deposited"

### Business Value
- **Financial Accuracy:** Ensures recorded transactions match actual cash on hand
- **Fraud Detection:** Identifies discrepancies that may indicate theft or errors
- **Accountability:** Creates clear responsibility for cash handling
- **Audit Trail:** Provides documentation for financial audits
- **Operational Insight:** Trends in discrepancies help identify training needs or process issues
- **Regulatory Compliance:** Meets requirements for financial controls and reconciliation

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Complete Daily Cash Close with No Discrepancies
```gherkin
Feature: Daily and Weekend Cash Close Validation
  As a Branch Manager
  I want to execute and validate daily/weekend cash closes
  So that recorded sales match physical cash and discrepancies are identified

Scenario: Successfully complete daily close when all cash matches
  Given I am logged in as a Branch Manager for branch "BR-001"
  And today is "2026-02-02" (Monday)
  And all cashiers have completed their individual register closings
  And the system shows the following summary for today:
    | Payment Method | Expected Amount |
    | Cash Sales     | $1,500.00       |
    | Debit Cards    | $2,300.00       |
    | Credit Cards   | $3,200.00       |
    | Total Sales    | $7,000.00       |
  And the starting cash drawer balance was $200.00
  And cashiers have counted and reported total cash of $1,700.00
  When I navigate to "Daily Cash Close"
  And I review the cash reconciliation:
    | Item                    | Amount      |
    | Opening Balance         | $200.00     |
    | Cash Sales              | $1,500.00   |
    | Expected Cash           | $1,700.00   |
    | Actual Cash Counted     | $1,700.00   |
    | Variance                | $0.00       |
  And I verify all amounts are correct
  And I click "Complete Daily Close"
  Then the system should mark the daily close as complete
  And the close should be timestamped with "2026-02-02 [current time]"
  And a daily close report should be generated and saved
  And I should see a confirmation "Daily close completed successfully - No discrepancies"
  And the General Director should receive a summary notification
```

### Scenario 2: Daily Close with Cash Shortage
```gherkin
Scenario: Complete daily close when cash drawer is short
  Given I am logged in as a Branch Manager
  And all cashiers have completed their register closings
  And the cash reconciliation shows:
    | Item                    | Amount      |
    | Opening Balance         | $200.00     |
    | Cash Sales              | $1,500.00   |
    | Expected Cash           | $1,700.00   |
    | Actual Cash Counted     | $1,685.00   |
    | Variance                | -$15.00     |
  And the variance is a shortage of $15.00
  When I review the daily close
  Then the system should flag the discrepancy with a warning "Cash shortage detected: $15.00"
  And the system should require me to add a comment explaining the variance
  When I add the comment "Investigated with all cashiers - unable to locate cause. Possible counting error."
  And I confirm the daily close with variance
  Then the system should complete the daily close
  And the shortage should be recorded and tracked
  And the General Director should be notified of the variance
  And the report should clearly show the shortage and explanation
```

### Scenario 3: Daily Close with Cash Overage
```gherkin
Scenario: Complete daily close when cash drawer has excess
  Given I am logged in as a Branch Manager
  And the cash reconciliation shows:
    | Item                    | Amount      |
    | Expected Cash           | $1,700.00   |
    | Actual Cash Counted     | $1,725.00   |
    | Variance                | +$25.00     |
  And the variance is an overage of $25.00
  When I review the daily close
  Then the system should flag the discrepancy "Cash overage detected: $25.00"
  And I should be required to add an explanation
  When I add the comment "Customer overpaid and left before receiving change - will keep in safe for customer return"
  And I complete the daily close
  Then the overage should be documented
  And the close should be marked complete with variance
```

### Scenario 4: Prevent Daily Close with Unclosed Cash Registers
```gherkin
Scenario: System prevents daily close when cashier drawers are still open
  Given I am logged in as a Branch Manager
  And it is time to complete the daily close
  And cashier "John Smith" has an open cash register session
  And cashier "John Smith" has not completed his register closing
  When I attempt to start the daily close process
  Then the system should prevent the daily close
  And display the message "Cannot complete daily close - the following cash registers are still open:"
  And show a list:
    | Cashier      | Register | Status |
    | John Smith   | POS-01   | Open   |
  And provide an option to "Notify Cashier" to complete their closing
  And I should not be able to proceed until all registers are closed
```

### Scenario 5: Complete Weekend Close for Multiple Days
```gherkin
Scenario: Execute weekend close covering Friday through Sunday
  Given I am logged in as a Branch Manager
  And today is "2026-02-03" (Monday morning)
  And I need to complete the weekend close for Friday, Saturday, and Sunday
  And the consolidated weekend summary shows:
    | Day      | Cash Sales | Debit Cards | Credit Cards | Total Sales |
    | Friday   | $2,100.00  | $3,200.00   | $4,500.00    | $9,800.00   |
    | Saturday | $2,800.00  | $4,100.00   | $5,900.00    | $12,800.00  |
    | Sunday   | $2,400.00  | $3,500.00   | $5,200.00    | $11,100.00  |
    | **Total**| $7,300.00  | $10,800.00  | $15,600.00   | $33,700.00  |
  And the weekend cash reconciliation shows:
    | Item                    | Amount      |
    | Opening Balance (Fri)   | $200.00     |
    | Total Cash Sales        | $7,300.00   |
    | Expected Cash           | $7,500.00   |
    | Actual Cash Counted     | $7,510.00   |
    | Variance                | +$10.00     |
  When I review the weekend close
  And I add explanation "Minor overage within acceptable range"
  And I complete the weekend close
  Then the system should create a weekend close report covering all three days
  And each day should be itemized in the report
  And the consolidated totals should be clearly shown
  And the close should be marked as "Weekend Close" for "2026-01-31 to 2026-02-02"
```

### Scenario 6: Review Individual Cashier Performance in Daily Close
```gherkin
Scenario: Branch Manager reviews which cashier had variance
  Given I am logged in as a Branch Manager
  And the daily close shows overall variance of -$20.00
  When I view the detailed cashier breakdown
  Then I should see:
    | Cashier        | Expected Cash | Actual Cash | Variance  |
    | John Smith     | $500.00       | $500.00     | $0.00     |
    | Susan Lee      | $600.00       | $580.00     | -$20.00   |
    | Mike Johnson   | $400.00       | $400.00     | $0.00     |
  And I should be able to see that the variance originated from "Susan Lee's" register
  And I should be able to add a note specific to "Susan Lee's" closing
  And this information should be available for historical tracking
```

### Scenario 7: Late Daily Close with Required Explanation
```gherkin
Scenario: Complete a daily close after the deadline
  Given I am logged in as a Branch Manager
  And today is "2026-02-03"
  And the daily close for "2026-02-02" was not completed
  And the deadline for daily close is "1 hour after closing time"
  And it is now "12 hours after closing time"
  When I attempt to complete the late daily close
  Then the system should flag this as a late close
  And require me to provide a reason for the delay
  When I enter the reason "Manager was ill - completed by supervisor next morning"
  And I complete the close
  Then the close should be marked as "Completed Late"
  And the delay reason should be documented
  And the General Director should be notified of the late close
```

### Scenario 8: Track and Report Cash Deposit After Close
```gherkin
Scenario: Record bank deposit after completing daily close
  Given I have completed the daily close
  And the total cash on hand is $1,700.00
  And the required starting balance for tomorrow is $200.00
  And the amount to deposit is $1,500.00
  When I navigate to "Record Bank Deposit"
  And the system suggests deposit amount of $1,500.00
  And I verify the physical cash to deposit
  And I enter deposit details:
    | Field                 | Value           |
    | Deposit Amount        | $1,500.00       |
    | Deposit Date          | 2026-02-02      |
    | Bank Account          | Account #12345  |
    | Deposit Reference     | DEP-20260202    |
  And I confirm the deposit
  Then the system should record the deposit
  And link it to the daily close for "2026-02-02"
  And update the cash on hand to $200.00 (starting balance for next day)
  And generate a deposit receipt for physical filing
```

### Scenario 9: Alert for Overdue Cash Close
```gherkin
Scenario: System alerts when daily close is overdue
  Given I am logged in as a Branch Manager
  And the business closed at "22:00" yesterday
  And the daily close deadline is "23:00" (1 hour after closing)
  And it is now "23:30"
  And the daily close has not been completed
  Then the system should display a prominent alert "Daily close overdue - Please complete immediately"
  And the system should send a notification to my mobile/email
  And the system should notify the General Director
  And the overdue status should be visible on the dashboard
```

### Scenario 10: View Historical Close Reports and Trends
```gherkin
Scenario: Branch Manager reviews historical close data to identify patterns
  Given I am logged in as a Branch Manager
  And I want to review historical cash close performance
  When I navigate to "Cash Close History"
  And I select date range "Last 30 days"
  Then I should see a report showing:
    | Date       | Type    | Total Sales | Variance | Status    |
    | 2026-02-02 | Daily   | $7,000.00   | $0.00    | Complete  |
    | 2026-02-01 | Daily   | $6,800.00   | -$5.00   | Complete  |
    | 2026-01-31 | Daily   | $7,200.00   | +$10.00  | Complete  |
  And I should be able to filter by:
    | Filter Option          |
    | Date Range             |
    | Type (Daily/Weekend)   |
    | Status (Complete/Late) |
    | Variance Amount        |
  And I should see analytics:
    | Metric                        | Value    |
    | Average Daily Sales           | $7,000   |
    | Average Variance              | $1.67    |
    | Number of Perfect Closes      | 1        |
    | Number of Closes with Variance| 2        |
```

---
