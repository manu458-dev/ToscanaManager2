# User Story US-04: Authorized Discount Application

## User Story Description

**ID:** US-04

**Priority:** High

**User Story:**
As a **Cashier**, I want to **apply discounts only with proper authorization** so that **discount fraud is prevented and sales integrity is maintained**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system must protect the business from unauthorized discounts while providing legitimate flexibility for promotions and customer service. Discount controls are critical for preventing fraud and maintaining profit margins across all branches.

### User Needs
**Branch Manager:** "We've had problems in the past with unauthorized discounts. I need to make sure that discounts are only applied when they should be, and that there's a clear record of who authorized them."

**System Analyst:** "What types of discounts do you offer at Toscana?"

**Branch Manager:** "We have several types:
- **Promotional discounts** (like 10% off on weekdays)
- **Loyalty program discounts** (for repeat customers)
- **Employee discounts** (for staff purchases)
- **Manager discretion discounts** (for service recovery or special circumstances)
- **Seasonal promotions** (holiday specials, happy hour discounts)"

**Cashier:** "From my perspective, customers often ask for discounts. Sometimes they have a valid coupon or they're part of our loyalty program. But sometimes they just ask for a discount because they're unhappy or think they can negotiate."

**System Analyst:** "How do you want to control which discounts can be applied?"

**Branch Manager:** "It should work like this:
- **Automatic discounts** (like happy hour pricing) should apply automatically when conditions are met
- **Standard promotional discounts** can be applied by cashiers without special approval
- **Manager discretion discounts** require a manager or supervisor to enter their credentials to approve
- Each discount should have a maximum percentage limit that cannot be exceeded"

**Cashier:** "What should I do when a customer asks for a discount that I can't apply on my own?"

**Branch Manager:** "You should be able to request authorization from a manager. The system should notify the manager, they can review the request, and either approve or deny it. The approval should include a reason."

**System Analyst:** "How should the system handle stacking multiple discounts?"

**Branch Manager:** "Good question. We should have rules about this:
- Some discounts can be combined (like loyalty + promotional)
- Some are exclusive (can't use employee discount with other promotions)
- There should be a maximum total discount percentage - let's say 30% - that can never be exceeded even with stacking"

**System Analyst:** "What information needs to be recorded when a discount is applied?"

**Branch Manager:** "I need to see:
- The type of discount applied
- The percentage or dollar amount
- Who applied it (the cashier)
- If authorization was required, who authorized it and why
- The original price and the discounted price
- The timestamp of when the discount was applied"

**Cashier:** "Sometimes I make a mistake and apply the wrong discount. Can I remove it?"

**Branch Manager:** "Yes, but removing a discount should also require authorization if it has already been authorized. We need to track discount removals too to prevent manipulation."

**System Analyst:** "What about discount codes or coupons that customers bring in?"

**Branch Manager:** "We should be able to configure discount codes in the system. When a customer provides a code, the cashier enters it, and the system validates:
- Is the code valid?
- Is it still within the valid date range?
- Has it already been used (if it's single-use)?
- Does it apply to the items in the cart?"

**Cashier:** "What if a manager isn't available to authorize a discount?"

**Branch Manager:** "Then the discount shouldn't be applied. The customer will need to wait, or the cashier can complete the sale at full price and we can process a refund adjustment later with proper authorization."

### Business Value
- **Fraud Prevention:** Reduces unauthorized discounts that erode profit margins
- **Accountability:** Creates clear audit trail of who applied and authorized discounts
- **Customer Service:** Allows legitimate discounts while maintaining controls
- **Revenue Protection:** Prevents revenue leakage from discount abuse
- **Compliance:** Ensures discounting policies are consistently enforced
- **Data Insights:** Provides visibility into discount usage patterns for business analysis

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Apply Standard Promotional Discount Without Authorization
```gherkin
Feature: Authorized Discount Application
  As a Cashier
  I want to apply discounts with proper authorization
  So that discount fraud is prevented and sales integrity is maintained

Scenario: Successfully apply a promotional discount that doesn't require authorization
  Given I am logged in as a Cashier
  And there is an active promotion "Weekday Lunch Special" with 15% discount
  And this promotion does not require manager authorization
  And I have added items totaling $50.00 to a sale
  And the current time is within the promotion period (Monday-Friday, 11:00-15:00)
  When I select the discount "Weekday Lunch Special"
  And I apply the discount to the sale
  Then the discount of 15% ($7.50) should be applied
  And the new total should be $42.50
  And the discount should be recorded with:
    | Field              | Value                   |
    | Discount Type      | Promotional             |
    | Discount Name      | Weekday Lunch Special   |
    | Percentage         | 15%                     |
    | Amount             | $7.50                   |
    | Applied By         | [Cashier User ID]       |
    | Authorization      | Not Required            |
    | Timestamp          | [Current Timestamp]     |
```

### Scenario 2: Request Manager Authorization for Discretionary Discount
```gherkin
Scenario: Cashier requests manager authorization for discretionary discount
  Given I am logged in as a Cashier
  And I have added items totaling $100.00 to a sale
  And a customer requests a discount due to a service issue
  When I select "Manager Discretion Discount"
  And I enter the requested discount percentage as 20%
  And I request manager authorization
  Then the system should prompt for manager credentials
  And the system should notify available managers of the pending authorization request
  When the Branch Manager "Jane Smith" enters her credentials
  And she enters the authorization reason "Service recovery - long wait time"
  And she approves the discount
  Then the 20% discount ($20.00) should be applied
  And the new total should be $80.00
  And the discount should be recorded with:
    | Field              | Value                           |
    | Discount Type      | Manager Discretion              |
    | Percentage         | 20%                             |
    | Amount             | $20.00                          |
    | Applied By         | [Cashier User ID]               |
    | Authorized By      | Jane Smith [Manager User ID]    |
    | Reason             | Service recovery - long wait    |
    | Timestamp          | [Current Timestamp]             |
```

### Scenario 3: Deny Unauthorized Discount Request
```gherkin
Scenario: Manager denies a discount authorization request
  Given I am logged in as a Cashier
  And I have added items totaling $75.00 to a sale
  And I have requested a 25% manager discretion discount
  And the request is pending manager authorization
  When the Branch Manager "Jane Smith" reviews the request
  And she determines the discount is not justified
  And she denies the authorization with reason "Customer request not valid"
  Then the discount should not be applied
  And the sale total should remain $75.00
  And I should receive a notification that the discount was denied
  And the denial should be logged with:
    | Field              | Value                           |
    | Requested By       | [Cashier User ID]               |
    | Denied By          | Jane Smith [Manager User ID]    |
    | Reason             | Customer request not valid      |
    | Timestamp          | [Current Timestamp]             |
```

### Scenario 4: Apply Discount Code with Validation
```gherkin
Scenario: Customer provides valid discount code
  Given I am logged in as a Cashier
  And there is a discount code "SPRING2026" configured with:
    | Property           | Value              |
    | Discount           | 10%                |
    | Valid From         | 2026-02-01         |
    | Valid Until        | 2026-03-31         |
    | Single Use         | No                 |
    | Min Purchase       | $25.00             |
  And I have added items totaling $60.00 to a sale
  And the current date is "2026-02-02"
  When the customer provides the code "SPRING2026"
  And I enter the code into the system
  Then the system should validate the code
  And the system should apply the 10% discount ($6.00)
  And the new total should be $54.00
  And the discount should be recorded with the code "SPRING2026"
```

### Scenario 5: Reject Invalid or Expired Discount Code
```gherkin
Scenario: Customer provides expired discount code
  Given I am logged in as a Cashier
  And there is a discount code "EXPIRED10" configured with:
    | Property           | Value              |
    | Discount           | 10%                |
    | Valid From         | 2026-01-01         |
    | Valid Until        | 2026-01-31         |
  And I have added items totaling $45.00 to a sale
  And the current date is "2026-02-02"
  When the customer provides the code "EXPIRED10"
  And I enter the code into the system
  Then the system should validate the code
  And the system should display "Code EXPIRED10 expired on 2026-01-31"
  And the discount should not be applied
  And the total should remain $45.00
```

### Scenario 6: Prevent Stacking Incompatible Discounts
```gherkin
Scenario: Attempt to stack exclusive discounts
  Given I am logged in as a Cashier
  And I have added items totaling $100.00 to a sale
  And there is an "Employee Discount" of 20% marked as exclusive
  And there is a "Loyalty Discount" of 10% marked as stackable
  When I apply the "Employee Discount" of 20%
  And the total becomes $80.00
  And I attempt to also apply the "Loyalty Discount"
  Then the system should display "Cannot combine Employee Discount with other discounts"
  And the system should prevent applying the second discount
  And only the Employee Discount should remain applied
  And the total should remain $80.00
```

### Scenario 7: Enforce Maximum Discount Limit
```gherkin
Scenario: Prevent discount exceeding maximum allowed percentage
  Given I am logged in as a Cashier
  And the system has a maximum discount limit of 30%
  And I have added items totaling $200.00 to a sale
  When I request a manager discretion discount of 40%
  And a manager attempts to authorize it
  Then the system should display "Discount cannot exceed maximum limit of 30%"
  And the system should not allow the 40% discount
  And the manager should be able to authorize up to 30% maximum
```

### Scenario 8: Stack Compatible Discounts Within Limits
```gherkin
Scenario: Apply multiple compatible discounts within maximum limit
  Given I am logged in as a Cashier
  And the system has a maximum total discount limit of 30%
  And I have added items totaling $100.00 to a sale
  And there is a "Loyalty Discount" of 10% marked as stackable
  And there is a "Promotional Discount" of 15% marked as stackable
  When I apply the "Loyalty Discount" of 10%
  And the total becomes $90.00
  And I apply the "Promotional Discount" of 15% on the original price
  Then the system should calculate the combined discount as 25%
  And the total discount amount should be $25.00
  And the new total should be $75.00
  And both discounts should be recorded separately on the receipt
```

### Scenario 9: Remove Authorized Discount with Proper Authorization
```gherkin
Scenario: Cashier removes an authorized discount by mistake
  Given I am logged in as a Cashier
  And I have applied a manager-authorized 20% discount to a $100.00 sale
  And the current total is $80.00
  And I realize the discount was applied to the wrong transaction
  When I attempt to remove the discount
  Then the system should require manager authorization for removal
  And the system should prompt for manager credentials
  When the Branch Manager enters credentials
  And provides the reason "Applied to wrong transaction in error"
  And approves the removal
  Then the discount should be removed
  And the total should return to $100.00
  And the removal should be logged with reason and authorizer
```

### Scenario 10: Automatic Discount Application Based on Conditions
```gherkin
Scenario: System automatically applies time-based discount
  Given there is an automatic "Happy Hour" discount configured with:
    | Property           | Value              |
    | Discount           | 20%                |
    | Active Days        | Monday-Friday      |
    | Active Hours       | 16:00-18:00        |
    | Category           | Beverages          |
    | Auto-Apply         | Yes                |
  And I am logged in as a Cashier
  And the current time is "2026-02-02 17:30:00" (Monday)
  When I add a beverage item priced at $10.00 to the sale
  Then the system should automatically apply the Happy Hour discount
  And the item price should be reduced to $8.00
  And the discount should be visible on the transaction
  And the discount should show "Happy Hour (Auto-Applied)"
```

---
