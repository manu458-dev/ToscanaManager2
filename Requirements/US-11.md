# User Story US-11: Branch-Level User Account Management

## User Story Description

**ID:** US-11

**Priority:** High

**User Story:**
As a **Branch Manager**, I want to **create, update, and deactivate user accounts for my branch** so that **only authorized employees have system access**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system requires robust user account management at the branch level. Branch Managers need the ability to onboard new employees, maintain existing user accounts, and properly offboard departing staff. This ensures that access to the system is properly controlled and that only current, authorized employees can perform operations within each branch.

### User Needs
**Branch Manager:** "I need to be able to manage my staff's access to the system without having to call IT or the corporate office every time. When I hire a new cashier, I should be able to create their account immediately so they can start working. When someone leaves, I need to deactivate their access right away."

**System Analyst:** "Walk me through hiring a new employee and setting up their account."

**Branch Manager:** "When a new employee starts, I need to:
- Create their user account with a username
- Set a temporary password they'll change on first login
- Assign them to my branch
- Give them the appropriate role (Cashier, Waiter, etc.)
- Enter their personal information (name, employee ID, contact info)
- Set their employment start date

The account should be active immediately so they can start training or working right away."

**System Analyst:** "What information is required versus optional for a new user account?"

**Branch Manager:** "Required fields should be:
- Full name (first and last)
- Username (unique across the system)
- Role (Cashier, Waiter, Shift Supervisor, etc.)
- Branch assignment
- Temporary password
- Employee ID number

Optional but helpful:
- Email address
- Phone number
- Emergency contact
- Employment start date
- Profile photo"

**System Analyst:** "Can you assign employees to roles outside your branch?"

**Branch Manager:** "No, I should only be able to manage employees assigned to my branch. I can't create accounts for other branches or see employees from other locations unless they transfer to my branch. This is important for security and data separation."

**System Analyst:** "What about updating existing accounts?"

**Branch Manager:** "I need to be able to:
- Change an employee's role (like promoting a cashier to shift supervisor)
- Update contact information
- Reset passwords when employees forget them
- Temporarily suspend accounts (like for employees on leave)
- Update personal information if it changes

But I shouldn't be able to change fundamental things like their username or employee ID - those should be permanent."

**System Analyst:** "When an employee leaves, what's the proper offboarding process?"

**Branch Manager:** "I should deactivate their account, not delete it. We need to keep the historical record of who they were and what they did for audit purposes. When I deactivate an account:
- They should immediately lose access to the system
- All their historical actions should remain in the system
- I should be able to see they're a former employee
- The account should note when it was deactivated and by whom
- If they're rehired later, we can reactivate the account"

**General Director:** "From a corporate perspective, I need visibility into user management across all branches. I should be able to see:
- How many active employees each branch has
- Recent account creations and deactivations
- Unusual patterns (like high turnover at a specific branch)

But the day-to-day management should be handled by Branch Managers."

**System Analyst:** "Should there be any restrictions on how many accounts a Branch Manager can create?"

**Branch Manager:** "Not a hard limit, but if I create an unusually large number of accounts in a short time, maybe the system should flag it for review. Normal hiring might be 1-3 new employees per month, so creating 10 accounts in one day might indicate an error or security issue."

**System Analyst:** "What happens when an employee transfers from one branch to another?"

**Branch Manager (sending branch):** "When an employee transfers out, I should be able to mark them as transferred rather than deactivated. Their account should move to the other branch."

**Branch Manager (receiving branch):** "When I receive a transferred employee, I should get a notification or pending approval to accept them into my branch. Once I approve, they become part of my team and I can manage their account."

**System Analyst:** "Can the same person have accounts at multiple branches?"

**Branch Manager:** "Normally no - an employee should be assigned to one primary branch. If someone works at multiple locations, that's an exception case that should involve the General Director."

**System Analyst:** "What about username standards? Should there be a format?"

**Branch Manager:** "It would be helpful if the system suggested usernames based on the employee's name. For example, if I hire John Smith, the system could suggest usernames like:
- john.smith
- jsmith
- j.smith

And show me if any are already taken. This keeps things consistent across branches."

**System Analyst:** "Should you be notified when accounts haven't been used recently?"

**Branch Manager:** "Yes, that would help identify inactive accounts. If an employee hasn't logged in for 30 days, I should get a notification. Maybe they quit and I forgot to deactivate them, or their account was created but they never started."

**System Analyst:** "What security measures should be in place for account creation?"

**Branch Manager:** "The system should:
- Require strong passwords (I covered this in US-06)
- Force password change on first login
- Verify I have proper permissions to create accounts
- Log all account creation, modification, and deactivation actions
- Prevent duplicate usernames
- Alert if I try to create accounts with duplicate employee IDs"

### Business Value
- **Security:** Ensures only authorized personnel have system access
- **Autonomy:** Empowers Branch Managers to manage their teams independently
- **Audit Trail:** Maintains complete history of account changes
- **Compliance:** Supports proper onboarding and offboarding processes
- **Efficiency:** Eliminates delays waiting for corporate IT to manage accounts
- **Accountability:** Clear ownership of who manages which accounts

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Create New User Account for New Employee
```gherkin
Feature: Branch-Level User Account Management
  As a Branch Manager
  I want to create, update, and deactivate user accounts for my branch
  So that only authorized employees have system access

Scenario: Successfully create a new cashier account
  Given I am logged in as a Branch Manager for branch "BR-001"
  And I have permission to manage user accounts
  When I navigate to "User Management"
  And I click "Create New User"
  And I enter the following information:
    | Field             | Value                |
    | First Name        | John                 |
    | Last Name         | Smith                |
    | Employee ID       | EMP-12345            |
    | Username          | john.smith           |
    | Role              | Cashier              |
    | Branch            | BR-001               |
    | Temporary Password| TempPass123!         |
    | Email             | john.smith@email.com |
    | Start Date        | 2026-02-03           |
  And I click "Create Account"
  Then the system should validate all required fields are complete
  And verify that username "john.smith" is not already taken
  And verify that employee ID "EMP-12345" is unique
  And create the user account with status "Active"
  And set the account to require password change on first login
  And assign the user to branch "BR-001" with role "Cashier"
  And I should see confirmation "User account created successfully for John Smith"
  And the account creation should be logged with my user ID and timestamp
```

### Scenario 2: System Suggests Username Based on Employee Name
```gherkin
Scenario: Get username suggestions when creating account
  Given I am creating a new user account
  And I have entered:
    | Field       | Value   |
    | First Name  | Maria   |
    | Last Name   | Garcia  |
  When I click in the "Username" field
  Then the system should suggest:
    | Suggested Username | Available |
    | maria.garcia       | Yes       |
    | m.garcia           | Yes       |
    | mgarcia            | No (taken)|
  And I should be able to select a suggestion or create my own
  And the system should validate uniqueness when I select or type
```

### Scenario 3: Prevent Creating Account with Duplicate Username
```gherkin
Scenario: System prevents duplicate usernames
  Given I am creating a new user account
  And username "john.smith" already exists in the system
  When I enter username "john.smith"
  And I attempt to create the account
  Then the system should display error "Username 'john.smith' is already taken"
  And prevent account creation
  And suggest alternative usernames:
    | Alternative Username |
    | john.smith2          |
    | j.smith              |
    | john.smith.br001     |
```

### Scenario 4: Update Employee Role (Promotion)
```gherkin
Scenario: Promote cashier to shift supervisor
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "John Smith" exists with:
    | Field    | Current Value   |
    | Username | john.smith      |
    | Role     | Cashier         |
    | Branch   | BR-001          |
  When I navigate to "User Management"
  And I select employee "John Smith"
  And I click "Edit User"
  And I change the role from "Cashier" to "Shift Supervisor"
  And I save the changes
  Then the user account should be updated with role "Shift Supervisor"
  And the user's permissions should immediately reflect the new role
  And the role change should be logged with:
    | Field         | Value                    |
    | User          | john.smith               |
    | Previous Role | Cashier                  |
    | New Role      | Shift Supervisor         |
    | Changed By    | [My User ID]             |
    | Timestamp     | [Current timestamp]      |
  And John Smith should see the new interface on next login
```

### Scenario 5: Reset Password for Employee
```gherkin
Scenario: Employee forgot password and requests reset
  Given I am logged in as a Branch Manager
  And employee "Susan Lee" with username "susan.lee" has forgotten her password
  When I navigate to "User Management"
  And I select user "susan.lee"
  And I click "Reset Password"
  And I generate a temporary password "TempReset456!"
  And I confirm the reset
  Then the system should reset the password to "TempReset456!"
  And set the account to require password change on next login
  And log the password reset with my user ID
  And I should be able to communicate the temporary password to Susan Lee
  And she should be forced to change it on her next login
```

### Scenario 6: Deactivate Account for Departing Employee
```gherkin
Scenario: Employee leaves company and account must be deactivated
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "Mike Johnson" with username "mike.johnson" is leaving the company
  And his last day is today
  And he has completed 150 transactions during his employment
  When I navigate to "User Management"
  And I select user "mike.johnson"
  And I click "Deactivate Account"
  And I enter the reason "Employee terminated - Last day 2026-02-02"
  And I confirm the deactivation
  Then the account status should change to "Inactive"
  And the deactivation date should be recorded as "2026-02-02"
  And the account should be marked with deactivation reason
  And "mike.johnson" should immediately lose all system access
  And all his historical transactions (150) should remain in the system
  And the account should not be deleteable
  And the deactivation should be logged
```

### Scenario 7: Prevent Managing Users from Other Branches
```gherkin
Scenario: Branch Manager cannot modify users from different branch
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "Alice Brown" exists and is assigned to branch "BR-002"
  When I navigate to "User Management"
  And I search for users
  Then I should only see users assigned to branch "BR-001"
  And "Alice Brown" should not appear in my user list
  When I attempt to directly access "Alice Brown's" profile using a URL or ID
  Then the system should deny access with message "Access Denied: User belongs to different branch"
  And the attempted access should be logged as a security event
```

### Scenario 8: Transfer Employee to Another Branch
```gherkin
Scenario: Employee transfers to different branch location
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "David Lee" is currently assigned to "BR-001"
  And he is transferring to "BR-003"
  When I navigate to user "David Lee's" profile
  And I click "Request Transfer"
  And I select destination branch "BR-003"
  And I enter transfer date "2026-02-10"
  And I add note "Employee requested transfer to location nearer home"
  And I submit the transfer request
  Then the system should notify the Branch Manager of "BR-003"
  And "David Lee" should remain in "BR-001" until "2026-02-10"
  And the transfer request should show as "Pending Approval"
  When the Branch Manager of "BR-003" approves the transfer
  Then on "2026-02-10", "David Lee" should be automatically reassigned to "BR-003"
  And I should lose management access to his account
  And the BR-003 Manager should gain management access
```

### Scenario 9: Reactivate Previously Deactivated Account
```gherkin
Scenario: Rehire former employee and reactivate their account
  Given I am logged in as a Branch Manager for branch "BR-001"
  And former employee "Sarah Wilson" was previously deactivated
  And her username was "sarah.wilson"
  And she is being rehired
  When I navigate to "User Management"
  And I filter for "Inactive Users"
  And I select "sarah.wilson"
  And I click "Reactivate Account"
  And I enter the rehire date "2026-02-03"
  And I reset her password to a new temporary password
  And I confirm reactivation
  Then the account should change status to "Active"
  And the reactivation date should be recorded
  And Sarah Wilson should be able to log in with the new temporary password
  And her historical data should still be available
  And the reactivation should be logged
```

### Scenario 10: Receive Alert for Inactive Accounts
```gherkin
Scenario: System alerts about accounts that haven't been used
  Given I am logged in as a Branch Manager for branch "BR-001"
  And employee "Tom Brown" has an active account
  And "Tom Brown" has not logged in for 35 days
  And the inactivity threshold is 30 days
  When the system runs its daily account review
  Then I should receive a notification:
    """
    Alert: Inactive Account
    
    User: Tom Brown (tom.brown)
    Last Login: 35 days ago
    Status: Active
    
    Action Required: Verify if this employee is still with the company.
    If not, please deactivate the account.
    """
  And I should be able to click through to the user's profile
  And I should see options to:
    | Option                    |
    | Deactivate Account        |
    | Mark as "On Leave"        |
    | Dismiss Alert (if valid)  |
  And the alert should remain until I take action
```

---
