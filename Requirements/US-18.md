# User Story US-18: Filter and View Reports by Branch

## User Story Description

**ID:** US-18

**Priority:** High

**User Story:**
As a **General Director**, I want to **filter and view reports by my specific branch or across all branches** so that **I can analyze performance at different organizational levels**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system generates various reports for business intelligence and decision-making. The General Director needs flexibility to view data at different levels of granularity - sometimes focusing on individual branch performance, other times comparing multiple branches, and frequently analyzing the entire corporate portfolio. Robust filtering capabilities are essential for effective analysis and strategic planning.

### User Needs
**General Director:** "I need to be able to slice and dice the data in different ways. Sometimes I want to see how all branches are performing together. Other times I want to focus on just one branch that's struggling or excelling. And sometimes I want to compare a subset of branches - like all locations in a particular city."

**System Analyst:** "What types of reports need branch filtering?"

**General Director:** "Pretty much all of them:
- Weekly and monthly reports
- Sales performance dashboards
- Financial summaries
- Product performance analysis
- Employee productivity reports
- Cash management reports
- Discount and promotion effectiveness

Any report that shows business metrics should let me filter by branch."

**System Analyst:** "What filtering options do you need?"

**General Director:** "Several levels of filtering:
- **All Branches:** Consolidated view across all 12 locations
- **Single Branch:** Deep dive into one specific location
- **Multiple Branches:** Select specific branches to compare
- **Branch Groups:** Maybe group by region or other criteria
- **Date Range:** Combine with time period filtering

And I should be able to switch between these views quickly without regenerating the whole report."

**System Analyst:** "Should the filtering be consistent across all reports?"

**General Director:** "Yes, I want the same filtering interface everywhere. If I'm used to selecting branches in one report, it should work the same way in all reports. Consistency makes the system easier to use."

**System Analyst:** "How should the filtered data be displayed?"

**General Director:** "It depends on what I'm viewing:
- **Single branch:** Show detailed metrics for just that branch, without comparison data cluttering the view
- **Multiple branches:** Show comparison tables or charts making it easy to see relative performance
- **All branches:** Show overall totals plus a breakdown by branch

The display should adapt to what makes sense for the filter selection."

**Branch Manager:** "From my perspective, when I log in, I should automatically see my branch's data. I shouldn't have access to filter and view other branches - that's the General Director's privilege."

**System Analyst:** "So branch filtering is role-based?"

**General Director:** "Exactly. Here's how it should work by role:
- **General Director:** Can view any branch, multiple branches, or all branches
- **Branch Manager:** Can only view their own branch (filtering controls disabled)
- **Cashiers, Waiters:** No access to reports, so filtering isn't relevant

The system should enforce these permissions automatically."

**System Analyst:** "Should filter selections be saved?"

**General Director:** "Yes! If I'm spending the day analyzing branches BR-001, BR-003, and BR-005, I don't want to reselect them every time I look at a different report. The system should:
- Remember my last filter selection
- Let me save custom filter sets (like 'Downtown Branches' or 'Underperforming Branches')
- Allow me to quickly switch between saved filters"

**System Analyst:** "How should the interface look for branch selection?"

**General Director:** "It should be:
- **Always visible:** Show current filter selection prominently
- **Easy to change:** One or two clicks to modify
- **Clear about what's selected:** 'All Branches (12)' or 'BR-001, BR-003' or '3 branches selected'
- **Visual:** Maybe a dropdown or multi-select with checkboxes

And when I change the filter, the report should update immediately or show 'Apply' button to refresh."

**System Analyst:** "What about exporting filtered reports?"

**General Director:** "Exports should respect the current filter. If I'm viewing data for BR-001 and BR-002, the exported PDF or Excel should contain only those two branches. The export filename should indicate the filter - like 'Sales_Report_BR001_BR002_2026-02-02.pdf'."

**CFO:** "I occasionally receive reports from the General Director. It should be clear which branches are included in any report I receive. The report should state 'This report includes data from: BR-001, BR-003, BR-005' or 'All Branches'."

**System Analyst:** "Can you combine branch filtering with other filters?"

**General Director:** "Absolutely. I should be able to:
- Filter by branch AND date range
- Filter by branch AND product category  
- Filter by branch AND payment method
- Any combination of relevant filters

For example: 'Show me credit card sales from branches BR-001 and BR-002 for the last 30 days.'"

**System Analyst:** "Should there be quick filter shortcuts?"

**General Director:** "That would be helpful. Some useful shortcuts:
- 'Top 5 Performers' (auto-select 5 branches with highest sales)
- 'Bottom 5 Performers' (auto-select 5 branches with lowest sales)
- 'Above Target' (branches exceeding their targets)
- 'Below Target' (branches missing their targets)

These would save time for common analysis tasks."

**System Analyst:** "How should comparison charts work with filtering?"

**General Director:** "When I select multiple branches:
- Bar charts should show each branch as a separate bar
- Line charts should show each branch as a separate line
- Pie charts should show branch contributions to the total
- Tables should list branches in rows

And I should be able to sort by any column - like sorting branches by sales to see ranking."

**System Analyst:** "What if someone tries to filter to branches they don't have permission for?"

**General Director:** "The system should prevent it. A Branch Manager shouldn't even see other branches in the filter dropdown. If somehow they try to access another branch's data through a URL or API, the system should deny it and log the attempt."

### Business Value
- **Strategic Analysis:** Enables focused analysis at appropriate organizational levels
- **Performance Comparison:** Makes it easy to identify top and bottom performers
- **Flexibility:** Supports ad-hoc analysis without custom reports
- **Efficiency:** Quick filtering eliminates need for multiple separate reports
- **Data Security:** Role-based filtering enforces proper access control
- **Decision Support:** Provides right level of detail for different decisions

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: View Report for All Branches (Default)
```gherkin
Feature: Filter and View Reports by Branch
  As a General Director
  I want to filter and view reports by specific branch or across all branches
  So that I can analyze performance at different organizational levels

Scenario: General Director views consolidated report for all branches
  Given I am logged in as the General Director
  When I navigate to "Weekly Sales Report"
  Then the default filter should be "All Branches"
  And the report should display data for all 12 branches
  And I should see:
    | Display Element          | Content                              |
    | Filter Indicator         | "All Branches (12)"                  |
    | Total Sales              | Consolidated sum across all branches |
    | Branch Breakdown Table   | All 12 branches listed               |
    | Comparison Charts        | All branches included                |
  And the report header should state "Report includes: All Branches"
```

### Scenario 2: Filter Report to Single Branch
```gherkin
Scenario: General Director views report for one specific branch
  Given I am viewing the "Weekly Sales Report"
  And the current filter is "All Branches"
  When I click on the branch filter dropdown
  And I select "Single Branch"
  And I choose "BR-001 - Toscana Downtown"
  And I click "Apply Filter"
  Then the report should refresh and display only data for branch "BR-001"
  And the filter indicator should show "BR-001 - Toscana Downtown"
  And the report should display:
    | Metric                  | Scope        |
    | Total Sales             | BR-001 only  |
    | Transactions            | BR-001 only  |
    | Top Products            | BR-001 only  |
    | Employee Performance    | BR-001 only  |
  And I should NOT see data from other branches
  And comparison charts should be replaced with single-branch detail views
```

### Scenario 3: Filter to Multiple Selected Branches
```gherkin
Scenario: Compare performance across subset of branches
  Given I am viewing a sales performance report
  When I click the branch filter
  And I select "Multiple Branches"
  And I check the following branches:
    | Branch  | Name                |
    | BR-001  | Toscana Downtown    |
    | BR-003  | Toscana Uptown      |
    | BR-007  | Toscana Westside    |
  And I click "Apply Filter"
  Then the report should display data only for the 3 selected branches
  And the filter indicator should show "3 branches selected"
  And comparison charts should include only those 3 branches
  And the report should show:
    | Chart Type       | Display                                    |
    | Bar Chart        | 3 bars (one per selected branch)           |
    | Comparison Table | 3 rows (one per selected branch)           |
    | Total            | Sum of only the 3 selected branches        |
```

### Scenario 4: Branch Manager Restricted to Own Branch
```gherkin
Scenario: Branch Manager can only view their assigned branch
  Given I am logged in as a Branch Manager for branch "BR-005"
  When I navigate to any report
  Then the branch filter should be fixed to "BR-005"
  And the filter should display "BR-005 - Toscana East (Your Branch)"
  And I should NOT see a dropdown to change branches
  And I should NOT see other branches in any list or chart
  And all reports should automatically show only BR-005 data
  When I attempt to access another branch's data via URL manipulation
  Then the system should deny access with "Access Denied: Insufficient permissions"
  And log the unauthorized access attempt
```

### Scenario 5: Save Custom Filter Set
```gherkin
Scenario: General Director saves frequently used branch filter
  Given I am logged in as the General Director
  And I have selected branches BR-001, BR-003, and BR-005
  When I click "Save Filter Set"
  And I name it "Downtown Locations"
  And I click "Save"
  Then the filter set should be saved to my profile
  And appear in my "Saved Filters" list
  When I later select "Downtown Locations" from saved filters
  Then the report should automatically filter to branches BR-001, BR-003, and BR-005
  And I should be able to apply this filter to any report
```

### Scenario 6: Combine Branch Filter with Date Range
```gherkin
Scenario: Apply multiple filters simultaneously
  Given I am viewing the sales report
  When I filter by branches:
    | Branch  |
    | BR-002  |
    | BR-004  |
  And I also filter by date range "2026-01-01 to 2026-01-31"
  And I apply the filters
  Then the report should show:
    | Filter Applied       | Value                     |
    | Branches             | BR-002, BR-004            |
    | Date Range           | January 2026              |
    | Data Scope           | Only those 2 branches for January |
  And the filter summary should display "BR-002, BR-004 | Jan 1-31, 2026"
  And all metrics should reflect this combined filter
```

### Scenario 7: Export Filtered Report with Filter Indicator
```gherkin
Scenario: Export respects current branch filter
  Given I am viewing a sales report
  And I have filtered to branches "BR-001" and "BR-003"
  And the date range is "2026-01-20 to 2026-01-26"
  When I click "Export as PDF"
  Then the exported file should be named "Sales_Report_BR001_BR003_2026-01-20_to_2026-01-26.pdf"
  And the PDF should contain only data from BR-001 and BR-003
  And the report header should state:
    """
    Report Scope:
    - Branches: BR-001 (Toscana Downtown), BR-003 (Toscana Uptown)
    - Period: 2026-01-20 to 2026-01-26
    """
  And no data from other branches should be included
```

### Scenario 8: Use Quick Filter Shortcut
```gherkin
Scenario: Quickly filter to top performing branches
  Given I am logged in as the General Director
  And all 12 branches have sales data for this week
  And the top 5 branches by sales are: BR-002, BR-004, BR-007, BR-009, BR-011
  When I navigate to the weekly sales report
  And I click "Quick Filters"
  And I select "Top 5 Performers"
  Then the system should automatically filter to the 5 highest-selling branches
  And the filter should show "Top 5 Performers (5 branches selected)"
  And the report should display only those 5 branches
  And they should be ranked from highest to lowest sales
```

### Scenario 9: Remember Last Filter Selection
```gherkin
Scenario: System remembers user's last filter across sessions
  Given I am logged in as the General Director
  And I filter a report to branches "BR-001, BR-005, BR-008"
  And I log out
  When I log back in the next day
  And I navigate to any report
  Then the branch filter should default to my last selection: "BR-001, BR-005, BR-008"
  And the report should display using this filter
  And I should be able to change it if needed
```

### Scenario 10: Display Clear Filter Status in Charts
```gherkin
Scenario: Charts clearly indicate which branches are included
  Given I am viewing a sales dashboard
  And I have filtered to "BR-002, BR-004, BR-006"
  When the dashboard displays a bar chart of sales by branch
  Then the chart should show:
    | Chart Element     | Display                                    |
    | Title             | "Sales by Branch (3 branches selected)"    |
    | Bars              | Only BR-002, BR-004, BR-006                |
    | Legend            | Branch names clearly labeled               |
    | Footer Note       | "Showing 3 of 12 total branches"           |
  And the chart should NOT include data from non-selected branches
  And it should be obvious this is filtered data, not complete data
```

---
