# User Story US-09: Cash Register Closing at End of Shift

## User Story Description

**ID:** US-09

**Priority:** High

**User Story:**
As a **Cashier**, I want to **perform a cash register closing at the end of my shift** so that **all transactions are reconciled and I can hand over responsibility to the next shift or management**.

---

## Detailed Conversation

### Context
The Toscana Manager 2.0 system must support individual cashier cash register closings that happen at the end of each shift. This process is distinct from the daily cash close performed by the Branch Manager - it's a cashier-level reconciliation that ensures each employee's cash drawer balances before they hand over or leave for the day. This creates accountability at the individual level and makes the manager's daily close process more straightforward.

### User Needs
**Cashier:** "At the end of my shift, I need to count all the cash in my drawer and make sure it matches what the system says I should have. Once I'm done and everything balances, I can close out and go home knowing my register is settled."

**System Analyst:** "Walk me through your typical shift closing process."

**Cashier:** "First, I make sure I'm not in the middle of any transaction. Then I tell the system I want to close my register. The system shows me:
- My starting cash amount (what was in the drawer when I logged in)
- Total cash sales I made during my shift
- Any cash refunds I processed
- What the expected cash total should be

Then I physically count all the bills and coins in my drawer and enter those amounts in the system. The system calculates if I'm over, short, or exactly right."

**System Analyst:** "What happens if you're short or over?"

**Cashier:** "If it's a small amount - like a few dollars or less - I can usually complete the closing and just note it. The system tracks these variances. If it's a larger amount, the system asks me to recount before finalizing. If I'm still off after recounting, I need to call a manager to approve the closing."

**Branch Manager:** "From my perspective, I need cashiers to complete their register closings before they leave. This makes my daily close much easier because I can see exactly which cashier had which variance. Each closed register feeds into my overall daily close."

**System Analyst:** "Can a cashier leave without closing their register?"

**Branch Manager:** "Technically yes, in case of emergency, but it's strongly discouraged. The system should warn them and require manager override. An unclosed register creates problems for the daily close and makes it hard to track accountability."

**System Analyst:** "What if a cashier needs to take a break but will return to the same register?"

**Cashier:** "For breaks, I just lock my session - I don't close the register. Register closing is only when I'm completely done for the day or handing over to someone else."

**System Analyst:** "What detail do you need when entering cash amounts?"

**Cashier:** "I need to enter denominations:
- Pennies ($0.01)
- Nickels ($0.05)
- Dimes ($0.10)
- Quarters ($0.25)
- $1 bills
- $5 bills
- $10 bills
- $20 bills
- $50 bills
- $100 bills

The system should calculate the total as I enter each denomination. This helps me verify my count is accurate."

**System Analyst:** "What should happen with the physical cash after you close?"

**Branch Manager:** "That depends on the time:
- **Mid-day shift change:** The closing cashier leaves their counted cash in the drawer for the next cashier (minus the starting amount which goes to the safe)
- **End of day:** All cash goes into the safe or drop box for the manager's daily close
- The system should guide the cashier on what to do with the cash based on whether another shift is coming"

**Cashier:** "It would be helpful if the system prints a closing slip that shows my register summary - my starting amount, sales, expected vs. actual, and variance. I can attach this to my cash deposit envelope."

**System Analyst:** "What if there are still open transactions or pending items?"

**Cashier:** "The system should check for:
- Any sale I started but didn't complete
- Any returns or voids pending manager approval
- Whether I've done all my transactions for open orders

If there are pending items, the system shouldn't let me close until they're resolved or transferred to another cashier."

**System Analyst:** "How should the system handle card payments in the closing?"

**Cashier:** "Card payments don't involve physical cash, but they should still appear in my closing summary for reference:
- Total credit card sales
- Total debit card sales
- Number of card transactions

This helps verify my overall sales activity even though cards don't affect the cash count."

**Branch Manager:** "I also need to see timing - I want to know if cashiers are closing their registers on time or if there are delays. This helps me manage labor costs and ensures we're following procedures."

**System Analyst:** "Should there be any limit on variances?"

**Branch Manager:** "We should have tolerance levels:
- **Under $5 variance:** Cashier can self-close with note
- **$5-$10 variance:** Require recount, then manager notification
- **Over $10 variance:** Mandatory manager approval before closing

These thresholds help us catch errors early while not creating excessive friction for small discrepancies."

**Cashier:** "Sometimes I realize after closing that I made a mistake in my count. Can I reopen my register?"

**Branch Manager:** "Once closed, a register should not be reopenable by the cashier. If there's truly an error, the cashier needs to notify a manager who can review and potentially adjust the record. This preserves the integrity of the closing process."

### Business Value
- **Individual Accountability:** Each cashier is responsible for their own cash drawer
- **Error Detection:** Identifies discrepancies immediately at the end of each shift
- **Simplified Daily Close:** Manager's daily close is easier with pre-reconciled registers
- **Audit Trail:** Clear record of who handled what cash and when
- **Training Feedback:** Recurring variances indicate need for additional cashier training
- **Shift Handover:** Clean transition between shifts with documented cash status

---

## Acceptance Criteria (Gherkin Style)

### Scenario 1: Complete Cash Register Closing with Exact Balance
```gherkin
Feature: Cash Register Closing at End of Shift
  As a Cashier
  I want to perform a cash register closing at the end of my shift
  So that all transactions are reconciled and I can hand over responsibility

Scenario: Successfully close register when cash matches exactly
  Given I am logged in as Cashier "John Smith"
  And I have completed my shift
  And my register summary shows:
    | Item                  | Amount    |
    | Starting Cash         | $200.00   |
    | Cash Sales            | $1,250.00 |
    | Cash Refunds          | -$50.00   |
    | Expected Cash         | $1,400.00 |
  And there are no pending transactions
  When I select "Close Cash Register"
  And I enter the cash count by denomination:
    | Denomination | Quantity | Amount   |
    | Pennies      | 0        | $0.00    |
    | Nickels      | 0        | $0.00    |
    | Dimes        | 0        | $0.00    |
    | Quarters     | 0        | $0.00    |
    | $1 bills     | 0        | $0.00    |
    | $5 bills     | 0        | $0.00    |
    | $10 bills    | 10       | $100.00  |
    | $20 bills    | 55       | $1,100.00|
    | $50 bills    | 0        | $0.00    |
    | $100 bills   | 2        | $200.00  |
  And the system calculates total counted as $1,400.00
  And I confirm the cash count
  Then the system should show variance of $0.00
  And the system should display "Perfect balance - No variance"
  And I should be able to complete the register closing
  When I click "Complete Closing"
  Then the register should be marked as closed
  And a closing slip should be printed showing:
    | Field             | Value                    |
    | Cashier           | John Smith               |
    | Register          | POS-01                   |
    | Shift Date        | 2026-02-02               |
    | Closing Time      | [Current timestamp]      |
    | Expected Cash     | $1,400.00                |
    | Actual Cash       | $1,400.00                |
    | Variance          | $0.00                    |
  And my session should be logged out
  And the closing should feed into the Branch Manager's daily close data
```

### Scenario 2: Cash Register Closing with Minor Shortage
```gherkin
Scenario: Complete closing with small variance under tolerance threshold
  Given I am logged in as a Cashier
  And my expected cash is $1,400.00
  And I have counted and entered $1,397.50
  And the variance is -$2.50 (shortage)
  And the variance is under the $5.00 self-close threshold
  When the system calculates the variance
  Then I should see a warning "Cash shortage of $2.50 detected"
  And I should be prompted to enter a note
  When I enter the note "Recounted twice - unable to locate discrepancy"
  And I confirm the closing
  Then the system should complete the register closing
  And the variance should be recorded as -$2.50
  And my note should be saved with the closing record
  And the Branch Manager should see this variance in the daily close review
  And a closing slip should print showing the variance clearly
```

### Scenario 3: Cash Register Closing with Overage
```gherkin
Scenario: Complete closing when cash drawer has excess
  Given I am logged in as a Cashier
  And my expected cash is $800.00
  And I have counted and entered $815.00
  And the variance is +$15.00 (overage)
  And the variance exceeds the $10.00 automatic approval threshold
  When the system calculates the variance
  Then the system should display "Cash overage of $15.00 detected - Manager approval required"
  And the system should notify the Branch Manager
  And I should not be able to complete closing without manager approval
  When the Branch Manager "Jane Smith" logs in to review
  And she approves the closing with note "Customer may have overpaid - keeping in safe pending claim"
  Then the register closing should be completed
  And the overage should be documented with manager approval
```

### Scenario 4: Prevent Closing with Pending Transactions
```gherkin
Scenario: System prevents closing when cashier has open transaction
  Given I am logged in as a Cashier
  And I have an active sale in progress with $45.00 in items
  And the transaction has not been completed or cancelled
  When I attempt to select "Close Cash Register"
  Then the system should display "Cannot close register - active transaction in progress"
  And the system should show details:
    | Blocking Issue        | Details                    |
    | Open Transaction      | $45.00 - In Progress       |
  And I should see options:
    | Option                              |
    | Complete the transaction            |
    | Void the transaction                |
    | Transfer to another cashier         |
  And the register closing should be blocked until the issue is resolved
```

### Scenario 5: Require Recount for Significant Variance
```gherkin
Scenario: System requires recount when variance exceeds threshold
  Given I am logged in as a Cashier
  And my expected cash is $1,200.00
  And I have counted and entered $1,192.00
  And the variance is -$8.00 (shortage)
  And the variance is between $5.00 and $10.00 thresholds
  When the system calculates the variance
  Then the system should display "Significant variance detected - Please recount your cash"
  And I should be prompted to recount before proceeding
  When I select "Recount Cash"
  And I enter the new count as $1,199.00
  And the new variance is -$1.00
  Then the system should accept the new count
  And I should be able to complete the closing
  And the system should record both count attempts for audit purposes
```

### Scenario 6: Display Card Payment Summary in Closing
```gherkin
Scenario: Register closing shows card payments for reference
  Given I am logged in as a Cashier
  And during my shift I processed:
    | Payment Type    | Total Amount | Transaction Count |
    | Cash            | $800.00      | 35                |
    | Debit Cards     | $1,200.00    | 28                |
    | Credit Cards    | $1,500.00    | 32                |
  When I view my register closing summary
  Then I should see all payment types displayed:
    | Payment Type    | Amount      | Count | Requires Physical Count |
    | Cash            | $800.00     | 35    | Yes                     |
    | Debit Cards     | $1,200.00   | 28    | No (Reference only)     |
    | Credit Cards    | $1,500.00   | 32    | No (Reference only)     |
    | **Total Sales** | $3,500.00   | 95    | -                       |
  And only cash should require denomination entry
  And card totals should appear for verification purposes only
```

### Scenario 7: Print Register Closing Slip
```gherkin
Scenario: Generate closing slip summary for physical records
  Given I have completed my register closing
  And my closing details are:
    | Field                  | Value                |
    | Cashier                | John Smith           |
    | Register ID            | POS-01               |
    | Branch                 | BR-001               |
    | Shift Start            | 08:00                |
    | Shift End              | 16:00                |
    | Starting Cash          | $200.00              |
    | Cash Sales             | $800.00              |
    | Cash Refunds           | -$20.00              |
    | Expected Cash          | $980.00              |
    | Actual Cash Counted    | $980.00              |
    | Variance               | $0.00                |
    | Debit Card Sales       | $1,200.00            |
    | Credit Card Sales      | $1,500.00            |
    | Total Shift Sales      | $3,500.00            |
  When the system prints the closing slip
  Then the slip should include all closing details
  And include signatures lines for:
    | Signature               |
    | Cashier Signature       |
    | Manager Approval (if required) |
  And include barcode or ID for tracking
  And be formatted for attachment to cash deposit envelope
```

### Scenario 8: Mid-Day Shift Change Cash Handling
```gherkin
Scenario: Guide cashier on cash handling during shift change
  Given I am closing my register at "14:00" (mid-afternoon)
  And another cashier will be starting the next shift on the same register
  And my closing shows $1,200.00 total cash
  And the standard starting amount is $200.00
  When I complete my closing
  Then the system should display instructions:
    """
    Cash Handling Instructions:
    1. Remove $1,000.00 from drawer (your shift sales)
    2. Place in cash deposit envelope with closing slip
    3. Deposit envelope in safe
    4. Leave $200.00 in drawer for next shift
    5. Notify manager that POS-01 is ready for next cashier
    """
  And the system should record that I deposited $1,000.00
  And the system should prepare the register for the next cashier with $200.00 starting balance
```

### Scenario 9: End-of-Day Register Closing
```gherkin
Scenario: Close register at end of business day
  Given I am closing my register at "22:00" (end of day)
  And no additional shifts will use this register today
  And my total cash is $1,800.00
  When I complete my closing
  Then the system should display instructions:
    """
    End of Day - Cash Handling:
    1. Remove ALL cash from drawer ($1,800.00)
    2. Place in cash deposit envelope with closing slip
    3. Deposit envelope in safe for manager's daily close
    4. Leave register drawer empty and open (security protocol)
    """
  And the system should mark the register as closed for the day
  And no starting balance should be set for tomorrow
```

### Scenario 10: Manager Review of All Cashier Closings
```gherkin
Scenario: Branch Manager views all register closings for the day
  Given I am logged in as a Branch Manager
  And today's date is "2026-02-02"
  And the following cashiers have closed their registers:
    | Cashier       | Register | Expected   | Actual     | Variance  | Status   |
    | John Smith    | POS-01   | $1,400.00  | $1,400.00  | $0.00     | Closed   |
    | Susan Lee     | POS-02   | $1,100.00  | $1,095.00  | -$5.00    | Closed   |
    | Mike Johnson  | POS-03   | $900.00    | $905.00    | +$5.00    | Closed   |
  When I navigate to "Cash Register Closings" for today
  Then I should see a summary of all closings
  And I should see total variance for the day of $0.00 (offsetting +/- $5)
  And I should be able to drill down into each cashier's detailed closing
  And I should see which register hasn't been closed yet (if any)
  And I should be able to use this data for my daily close reconciliation
```

---
